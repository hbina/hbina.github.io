<!doctype html><html lang=en><meta charset=utf-8><head><title>althttpd: From Top to Bottom</title><body><section class=section><div class=container><div><h1 class=title>althttpd: From Top to Bottom</h1><p class=subtitle><strong></strong><hr><h1 id=introduction>Introduction</h1><p>I am not knowledgeable in this. Some of the information in these articles might be outright false. Don't trust anything I say. I just thought it might be interesting to document how I would go through this codebase. Might be useful to new programmers to learn the tools of the trade (which I am learning how to use too!).<h2 id=before-venturing-further>Before Venturing Further...</h2><p>It's nice to have the codebase open as reference. Each chapters will cover mostly 1 function and I wouldn't go through every single bit. Just the parts that I find interesting. I will cover the global variables as we go through.<p>Sometimes there will be backtracking and jumping ahead of the source code as I see necessary.<p>Please read about the design philosophy <a href=https://sqlite.org/althttpd/doc/trunk/althttpd.md>here</a>.<p>Check out the source code <a href=../althttpd/althttpd.c>here</a>.<h1 id=escape>Escape</h1><p>This function accepts a C-string and returns another C-string with every double-quote doubled.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Double any double-quote characters in a string.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static char </span><span>*</span><span style=color:#8fa1b3;>Escape</span><span>(</span><span style=color:#b48ead;>char </span><span>*</span><span style=color:#bf616a;>z</span><span>){
</span><span>  size_t i, j;
</span><span>  size_t n;
</span><span>  </span><span style=color:#b48ead;>char</span><span> c;
</span><span>  </span><span style=color:#b48ead;>char </span><span>*zOut;
</span><span>  </span><span style=color:#b48ead;>for</span><span>(i=</span><span style=color:#d08770;>0</span><span>; (c=z[i])!=</span><span style=color:#d08770;>0 </span><span>&& c!='</span><span style=color:#a3be8c;>"</span><span>'; i++){}
</span><span>  </span><span style=color:#b48ead;>if</span><span>( c==</span><span style=color:#d08770;>0 </span><span>) </span><span style=color:#b48ead;>return</span><span> z;
</span><span>  n = </span><span style=color:#d08770;>1</span><span>;
</span><span>  </span><span style=color:#b48ead;>for</span><span>(i++; (c=z[i])!=</span><span style=color:#d08770;>0</span><span>; i++){ </span><span style=color:#b48ead;>if</span><span>( c=='</span><span style=color:#a3be8c;>"</span><span>' ) n++; }
</span><span>  zOut = </span><span style=color:#96b5b4;>malloc</span><span>( i+n+</span><span style=color:#d08770;>1 </span><span>);
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zOut==</span><span style=color:#d08770;>0 </span><span>) </span><span style=color:#b48ead;>return </span><span>"";
</span><span>  </span><span style=color:#b48ead;>for</span><span>(i=j=</span><span style=color:#d08770;>0</span><span>; (c=z[i])!=</span><span style=color:#d08770;>0</span><span>; i++){
</span><span>    zOut[j++] = c;
</span><span>    </span><span style=color:#b48ead;>if</span><span>( c=='</span><span style=color:#a3be8c;>"</span><span>' ) zOut[j++] = c;
</span><span>  }
</span><span>  zOut[j] = </span><span style=color:#d08770;>0</span><span>;
</span><span>  </span><span style=color:#b48ead;>return</span><span> zOut;
</span><span>}
</span></code></pre><p>First we have the variable declarations at the top of the function... So its one of those code. <em>sigh</em>. Second, we can see that there is 0 calls to <code>strlen</code>. We perform a single pass on the original strings and a second one on the output string. Pretty cool.<p>Notice that the caller of this function have no real way to know if allocations have been made. However, from the design philosophy,<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>Because each althttpd process only needs to service a single connection, althttpd is single threaded.
</span><span>Furthermore, each process only lives for the duration of a single connection, which means that althttpd does not need to worry too much about memory leaks.
</span><span>These design factors help keep the althttpd source code simple, which facilitates security auditing and analysis.
</span></code></pre><p>So this seems like a conscious desicion. If you grep for this function, its only being used in one place.<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>bash-3.2$</span><span> rg '</span><span style=color:#a3be8c;>Escape</span><span>' ./content/althttpd.c
</span><span style=color:#bf616a;>387:static</span><span> char *Escape(char *z){
</span><span style=color:#bf616a;>481:</span><span>        zDate, zRemoteAddr, zHttp, Escape(zHttpHost)</span><span style=color:#bf616a;>,</span><span> Escape(zScript)</span><span style=color:#bf616a;>,
</span><span style=color:#bf616a;>482:</span><span>        Escape(zReferer)</span><span style=color:#bf616a;>,</span><span> zReplyStatus, nIn, nOut,
</span><span style=color:#bf616a;>488:</span><span>        nRequest, Escape(zAgent)</span><span style=color:#bf616a;>,</span><span> Escape(zRM)</span><span style=color:#bf616a;>,
</span></code></pre><p>Notice that they don't even assign the pointer returned by this function! I will let you judge whether this is good idea or not.<h1 id=tvms>tvms</h1><p>This function is pretty much self explanatory. It is what is... I guess I can start reading about the time utility in libc.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Convert a struct timeval into an integer number of microseconds
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static long long int </span><span style=color:#8fa1b3;>tvms</span><span>(</span><span style=color:#b48ead;>struct</span><span> timeval *</span><span style=color:#bf616a;>p</span><span>){
</span><span>  </span><span style=color:#b48ead;>return </span><span>((</span><span style=color:#b48ead;>long long int</span><span>)p->tv_sec)*</span><span style=color:#d08770;>1000000 </span><span>+ (</span><span style=color:#b48ead;>long long int</span><span>)p->tv_usec;
</span><span>}
</span></code></pre><h3 id=references>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/gettimeofday.3p.html>gettimeofday</a></ol><h1 id=makelogentry>MakeLogEntry</h1><p>This function is quite big. Lets dig in.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Make an entry in the log file.  If the HTTP connection should be
</span><span style=color:#65737e;>** closed, then terminate this process.  Otherwise return.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>MakeLogEntry</span><span>(</span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>exitCode</span><span>, </span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>lineNum</span><span>){
</span><span>  FILE *log;
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zTmpNam ){
</span><span>    </span><span style=color:#bf616a;>unlink</span><span>(zTmpNam);
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zLogFile && !omitLog ){
</span><span>    </span><span style=color:#b48ead;>struct</span><span> timeval now;
</span><span>    </span><span style=color:#b48ead;>struct</span><span> tm *pTm;
</span><span>    </span><span style=color:#b48ead;>struct</span><span> rusage self, children;
</span><span>    </span><span style=color:#b48ead;>int</span><span> waitStatus;
</span><span>    </span><span style=color:#b48ead;>char </span><span>*zRM = zRemoteUser ? zRemoteUser : "";
</span><span>    </span><span style=color:#b48ead;>char </span><span>*zFilename;
</span><span>    size_t sz;
</span><span>    </span><span style=color:#b48ead;>char</span><span> zDate[</span><span style=color:#d08770;>200</span><span>];
</span><span>    </span><span style=color:#b48ead;>char</span><span> zExpLogFile[</span><span style=color:#d08770;>500</span><span>];
</span><span>
</span><span>    </span><span style=color:#b48ead;>if</span><span>( zScript==</span><span style=color:#d08770;>0 </span><span>) zScript = "";
</span><span>    </span><span style=color:#b48ead;>if</span><span>( zRealScript==</span><span style=color:#d08770;>0 </span><span>) zRealScript = "";
</span><span>    </span><span style=color:#b48ead;>if</span><span>( zRemoteAddr==</span><span style=color:#d08770;>0 </span><span>) zRemoteAddr = "";
</span><span>    </span><span style=color:#b48ead;>if</span><span>( zHttpHost==</span><span style=color:#d08770;>0 </span><span>) zHttpHost = "";
</span><span>    </span><span style=color:#b48ead;>if</span><span>( zReferer==</span><span style=color:#d08770;>0 </span><span>) zReferer = "";
</span><span>    </span><span style=color:#b48ead;>if</span><span>( zAgent==</span><span style=color:#d08770;>0 </span><span>) zAgent = "";
</span><span>    </span><span style=color:#bf616a;>gettimeofday</span><span>(&now, </span><span style=color:#d08770;>0</span><span>);
</span><span>    pTm = </span><span style=color:#96b5b4;>localtime</span><span>(&now.</span><span style=color:#bf616a;>tv_sec</span><span>);
</span><span>    </span><span style=color:#96b5b4;>strftime</span><span>(zDate, sizeof(zDate), "</span><span style=color:#a3be8c;>%Y-%m-</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;> %H:%M:</span><span style=color:#d08770;>%S</span><span>", pTm);
</span><span>    sz = </span><span style=color:#96b5b4;>strftime</span><span>(zExpLogFile, sizeof(zExpLogFile), zLogFile, pTm);
</span><span>    </span><span style=color:#b48ead;>if</span><span>( sz></span><span style=color:#d08770;>0 </span><span>&& sz&LTsizeof(zExpLogFile)-</span><span style=color:#d08770;>2 </span><span>){
</span><span>      zFilename = zExpLogFile;
</span><span>    }</span><span style=color:#b48ead;>else</span><span>{
</span><span>      zFilename = zLogFile;
</span><span>    }
</span><span>    </span><span style=color:#bf616a;>waitpid</span><span>(-</span><span style=color:#d08770;>1</span><span>, &waitStatus, WNOHANG);
</span><span>    </span><span style=color:#bf616a;>getrusage</span><span>(RUSAGE_SELF, &self);
</span><span>    </span><span style=color:#bf616a;>getrusage</span><span>(RUSAGE_CHILDREN, &children);
</span><span>    </span><span style=color:#b48ead;>if</span><span>( (log = </span><span style=color:#96b5b4;>fopen</span><span>(zFilename,"</span><span style=color:#a3be8c;>a</span><span>"))!=</span><span style=color:#d08770;>0 </span><span>){
</span><span style=color:#b48ead;>#ifdef</span><span> COMBINED_LOG_FORMAT
</span><span>      </span><span style=color:#96b5b4;>strftime</span><span>(zDate, sizeof(zDate), "</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>/%b/%Y:%H:%M:</span><span style=color:#d08770;>%S</span><span style=color:#a3be8c;> %Z</span><span>", pTm);
</span><span>      </span><span style=color:#96b5b4;>fprintf</span><span>(log, "</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;> - - [</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>] </span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s %s %s</span><span style=color:#96b5b4;>\" </span><span style=color:#d08770;>%s %d </span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\" \"</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\"\n</span><span>",
</span><span>              zRemoteAddr, zDate, zMethod, zScript, zProtocol,
</span><span>              zReplyStatus, nOut, zReferer, zAgent);
</span><span style=color:#b48ead;>#else
</span><span>      </span><span style=color:#96b5b4;>strftime</span><span>(zDate, sizeof(zDate), "</span><span style=color:#a3be8c;>%Y-%m-</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;> %H:%M:</span><span style=color:#d08770;>%S</span><span>", pTm);
</span><span>      </span><span style=color:#65737e;>/* Log record files:
</span><span style=color:#65737e;>      **  (1) Date and time
</span><span style=color:#65737e;>      **  (2) IP address
</span><span style=color:#65737e;>      **  (3) URL being accessed
</span><span style=color:#65737e;>      **  (4) Referer
</span><span style=color:#65737e;>      **  (5) Reply status
</span><span style=color:#65737e;>      **  (6) Bytes received
</span><span style=color:#65737e;>      **  (7) Bytes sent
</span><span style=color:#65737e;>      **  (8) Self user time
</span><span style=color:#65737e;>      **  (9) Self system time
</span><span style=color:#65737e;>      ** (10) Children user time
</span><span style=color:#65737e;>      ** (11) Children system time
</span><span style=color:#65737e;>      ** (12) Total wall-clock time
</span><span style=color:#65737e;>      ** (13) Request number for same TCP/IP connection
</span><span style=color:#65737e;>      ** (14) User agent
</span><span style=color:#65737e;>      ** (15) Remote user
</span><span style=color:#65737e;>      ** (16) Bytes of URL that correspond to the SCRIPT_NAME
</span><span style=color:#65737e;>      ** (17) Line number in source file
</span><span style=color:#65737e;>      */
</span><span>      </span><span style=color:#96b5b4;>fprintf</span><span>(log,
</span><span>        "</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>,</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>://</span><span style=color:#d08770;>%s%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>,</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>,</span><span>"
</span><span>           "</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>,</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>,</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#96b5b4;>\n</span><span>",
</span><span>        zDate, zRemoteAddr, zHttp, </span><span style=color:#bf616a;>Escape</span><span>(zHttpHost), </span><span style=color:#bf616a;>Escape</span><span>(zScript),
</span><span>        </span><span style=color:#bf616a;>Escape</span><span>(zReferer), zReplyStatus, nIn, nOut,
</span><span>        </span><span style=color:#bf616a;>tvms</span><span>(&self.</span><span style=color:#bf616a;>ru_utime</span><span>) - </span><span style=color:#bf616a;>tvms</span><span>(&priorSelf.</span><span style=color:#bf616a;>ru_utime</span><span>),
</span><span>        </span><span style=color:#bf616a;>tvms</span><span>(&self.</span><span style=color:#bf616a;>ru_stime</span><span>) - </span><span style=color:#bf616a;>tvms</span><span>(&priorSelf.</span><span style=color:#bf616a;>ru_stime</span><span>),
</span><span>        </span><span style=color:#bf616a;>tvms</span><span>(&children.</span><span style=color:#bf616a;>ru_utime</span><span>) - </span><span style=color:#bf616a;>tvms</span><span>(&priorChild.</span><span style=color:#bf616a;>ru_utime</span><span>),
</span><span>        </span><span style=color:#bf616a;>tvms</span><span>(&children.</span><span style=color:#bf616a;>ru_stime</span><span>) - </span><span style=color:#bf616a;>tvms</span><span>(&priorChild.</span><span style=color:#bf616a;>ru_stime</span><span>),
</span><span>        </span><span style=color:#bf616a;>tvms</span><span>(&now) - </span><span style=color:#bf616a;>tvms</span><span>(&beginTime),
</span><span>        nRequest, </span><span style=color:#bf616a;>Escape</span><span>(zAgent), </span><span style=color:#bf616a;>Escape</span><span>(zRM),
</span><span>        (</span><span style=color:#b48ead;>int</span><span>)(</span><span style=color:#96b5b4;>strlen</span><span>(zHttp)+</span><span style=color:#96b5b4;>strlen</span><span>(zHttpHost)+</span><span style=color:#96b5b4;>strlen</span><span>(zRealScript)+</span><span style=color:#d08770;>3</span><span>),
</span><span>        lineNum
</span><span>      );
</span><span>      priorSelf = self;
</span><span>      priorChild = children;
</span><span style=color:#b48ead;>#endif
</span><span>      </span><span style=color:#96b5b4;>fclose</span><span>(log);
</span><span>      nIn = nOut = </span><span style=color:#d08770;>0</span><span>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>if</span><span>( closeConnection ){
</span><span>    </span><span style=color:#96b5b4;>exit</span><span>(exitCode);
</span><span>  }
</span><span>  statusSent = </span><span style=color:#d08770;>0</span><span>;
</span><span>}
</span></code></pre><p>Grepping for the usage of this function, we get:<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>bash-3.2$</span><span> rg '</span><span style=color:#a3be8c;>MakeLogEntry</span><span>' ./content/althttpd/althttpd.c
</span><span style=color:#bf616a;>417:static</span><span> void MakeLogEntry(int exitCode, int lineNum){
</span><span style=color:#bf616a;>514:</span><span>    MakeLogEntry(1,100);  </span><span style=color:#bf616a;>/*</span><span> LOG: Malloc() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>708:</span><span>  MakeLogEntry(0, lineno);
</span><span style=color:#bf616a;>723:</span><span>  MakeLogEntry(0, lineno);
</span><span style=color:#bf616a;>741:</span><span>  MakeLogEntry(0, 110);  </span><span style=color:#bf616a;>/*</span><span> LOG: Not authorized */
</span><span style=color:#bf616a;>756:</span><span>  MakeLogEntry(0, 120);  </span><span style=color:#bf616a;>/*</span><span> LOG: CGI Error */
</span><span style=color:#bf616a;>773:</span><span>      MakeLogEntry(0, 130);  </span><span style=color:#bf616a;>/*</span><span> LOG: Timeout */
</span><span style=color:#bf616a;>789:</span><span>  MakeLogEntry(0, 140);  </span><span style=color:#bf616a;>/*</span><span> LOG: CGI script is writable */
</span><span style=color:#bf616a;>809:</span><span>  MakeLogEntry(0, linenum);
</span><span style=color:#bf616a;>840:</span><span>    MakeLogEntry(0, lineno);
</span><span style=color:#bf616a;>1323:</span><span>    MakeLogEntry(0, 470);  </span><span style=color:#bf616a;>/*</span><span> LOG: ETag Cache Hit */
</span><span style=color:#bf616a;>1347:</span><span>    MakeLogEntry(0, 2); </span><span style=color:#bf616a;>/*</span><span> LOG: Normal HEAD reply */
</span><span style=color:#bf616a;>1684:</span><span>    MakeLogEntry(0, 200); </span><span style=color:#bf616a;>/*</span><span> LOG: bad protocol in HTTP header */
</span><span style=color:#bf616a;>1709:</span><span>    MakeLogEntry(0, 220); </span><span style=color:#bf616a;>/*</span><span> LOG: Unknown request method */
</span><span style=color:#bf616a;>1908:</span><span>      MakeLogEntry(0, 270); </span><span style=color:#bf616a;>/*</span><span> LOG: Request too large */
</span><span style=color:#bf616a;>1926:</span><span>      MakeLogEntry(0, 290); </span><span style=color:#bf616a;>/*</span><span> LOG: cannot create temp file for POST */
</span><span style=color:#bf616a;>2219:</span><span>  MakeLogEntry(0, 0);  </span><span style=color:#bf616a;>/*</span><span> LOG: Normal reply */
</span></code></pre><p>It seems that most (if not all) of these usages are related to logging before killing the connection process. It accepts the <code>exitCode</code> that the process should return, and a <code>lineNum</code>.<p>The second parameter is supposed to indicate the approximate line number this function is called. Probably for debugging purposes.<p>The first thing we do in the function is to unlink a file.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#b48ead;>if</span><span>( zTmpNam ){
</span><span>  </span><span style=color:#bf616a;>unlink</span><span>(zTmpNam);
</span><span>}
</span></code></pre><p>Grepping for <code>zTmpNam</code> yields,<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>bash-3.2$</span><span> rg '</span><span style=color:#a3be8c;>zTmpNam</span><span>' ./content/althttpd/althttpd.c
</span><span style=color:#bf616a;>290:static</span><span> char *zTmpNam = 0;        </span><span style=color:#bf616a;>/*</span><span> Name of a temporary file */
</span><span style=color:#bf616a;>291:static</span><span> char zTmpNamBuf</span><span style=color:#b48ead;>[</span><span>500</span><span style=color:#b48ead;>]</span><span>;     </span><span style=color:#bf616a;>/*</span><span> Space to hold the temporary filename */
</span><span style=color:#bf616a;>419:</span><span>  if( zTmpNam ){
</span><span style=color:#bf616a;>420:</span><span>    unlink(zTmpNam);
</span><span style=color:#bf616a;>1310:</span><span>  if( zTmpNam ) </span><span style=color:#bf616a;>unlink</span><span>(zTmpNam);
</span><span style=color:#bf616a;>1610:   </span><span>&& (</span><span style=color:#bf616a;>in</span><span> = fopen(zTmpNam,"</span><span style=color:#a3be8c;>r</span><span>"))</span><span style=color:#bf616a;>!</span><span>=</span><span style=color:#a3be8c;>0 </span><span>){
</span><span style=color:#bf616a;>1912:</span><span>    sprintf(zTmpNamBuf, "</span><span style=color:#a3be8c;>/tmp/-post-data-XXXXXX</span><span>");
</span><span style=color:#bf616a;>1913:</span><span>    zTmpNam = zTmpNamBuf;
</span><span style=color:#bf616a;>1914:</span><span>    if( mkstemp(zTmpNam)<</span><span style=color:#d08770;>0 </span><span>){
</span><span style=color:#bf616a;>1918:</span><span>    out = fopen(zTmpNam,"</span><span style=color:#a3be8c;>wb</span><span>");
</span><span style=color:#bf616a;>1924:        </span><span>"</span><span style=color:#a3be8c;>Could not open </span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;> for writing\n</span><span>", zTmpNam
</span><span style=color:#bf616a;>2155:</span><span>      open(zTmpNam, O_RDONLY);
</span></code></pre><p>So <code>zTmpNam</code> is basically a temporary file created from <code>mkstemp</code>. Then, if <code>zLogFile</code> is provided and <code>omitLog</code> is false, we start some logging procedures. This block of statements here:<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#b48ead;>if</span><span>( zScript==</span><span style=color:#d08770;>0 </span><span>) zScript = "";
</span><span style=color:#b48ead;>if</span><span>( zRealScript==</span><span style=color:#d08770;>0 </span><span>) zRealScript = "";
</span><span style=color:#b48ead;>if</span><span>( zRemoteAddr==</span><span style=color:#d08770;>0 </span><span>) zRemoteAddr = "";
</span><span style=color:#b48ead;>if</span><span>( zHttpHost==</span><span style=color:#d08770;>0 </span><span>) zHttpHost = "";
</span><span style=color:#b48ead;>if</span><span>( zReferer==</span><span style=color:#d08770;>0 </span><span>) zReferer = "";
</span><span style=color:#b48ead;>if</span><span>( zAgent==</span><span style=color:#d08770;>0 </span><span>) zAgent = "";
</span><span style=color:#bf616a;>gettimeofday</span><span>(&now, </span><span style=color:#d08770;>0</span><span>);
</span><span>pTm = </span><span style=color:#96b5b4;>localtime</span><span>(&now.</span><span style=color:#bf616a;>tv_sec</span><span>);
</span><span style=color:#bf616a;>strftime</span><span>(zDate, sizeof(zDate), "</span><span style=color:#a3be8c;>%Y-%m-</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;> %H:%M:</span><span style=color:#d08770;>%S</span><span>", pTm);
</span><span>sz = </span><span style=color:#96b5b4;>strftime</span><span>(zExpLogFile, sizeof(zExpLogFile), zLogFile, pTm);
</span><span style=color:#b48ead;>if</span><span>( sz></span><span style=color:#d08770;>0 </span><span>&& sz&LTsizeof(zExpLogFile)-</span><span style=color:#d08770;>2 </span><span>){
</span><span>  zFilename = zExpLogFile;
</span><span>}</span><span style=color:#b48ead;>else</span><span>{
</span><span>  zFilename = zLogFile;
</span><span>}
</span><span style=color:#bf616a;>waitpid</span><span>(-</span><span style=color:#d08770;>1</span><span>, &waitStatus, WNOHANG);
</span><span style=color:#bf616a;>getrusage</span><span>(RUSAGE_SELF, &self);
</span><span style=color:#bf616a;>getrusage</span><span>(RUSAGE_CHILDREN, &children);
</span></code></pre><p>Is basically to get the current state of the process that will be logged. The other interesting part of the program is in the logging itself.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#96b5b4;>fprintf</span><span>(log,
</span><span>  "</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>,</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>://</span><span style=color:#d08770;>%s%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>,</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>,</span><span>"
</span><span>      "</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%lld</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>,</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>,</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>,</span><span style=color:#d08770;>%d</span><span style=color:#96b5b4;>\n</span><span>",
</span><span>  zDate, zRemoteAddr, zHttp, </span><span style=color:#bf616a;>Escape</span><span>(zHttpHost), </span><span style=color:#bf616a;>Escape</span><span>(zScript),
</span><span>  </span><span style=color:#bf616a;>Escape</span><span>(zReferer), zReplyStatus, nIn, nOut,
</span><span>  </span><span style=color:#bf616a;>tvms</span><span>(&self.</span><span style=color:#bf616a;>ru_utime</span><span>) - </span><span style=color:#bf616a;>tvms</span><span>(&priorSelf.</span><span style=color:#bf616a;>ru_utime</span><span>),
</span><span>  </span><span style=color:#bf616a;>tvms</span><span>(&self.</span><span style=color:#bf616a;>ru_stime</span><span>) - </span><span style=color:#bf616a;>tvms</span><span>(&priorSelf.</span><span style=color:#bf616a;>ru_stime</span><span>),
</span><span>  </span><span style=color:#bf616a;>tvms</span><span>(&children.</span><span style=color:#bf616a;>ru_utime</span><span>) - </span><span style=color:#bf616a;>tvms</span><span>(&priorChild.</span><span style=color:#bf616a;>ru_utime</span><span>),
</span><span>  </span><span style=color:#bf616a;>tvms</span><span>(&children.</span><span style=color:#bf616a;>ru_stime</span><span>) - </span><span style=color:#bf616a;>tvms</span><span>(&priorChild.</span><span style=color:#bf616a;>ru_stime</span><span>),
</span><span>  </span><span style=color:#bf616a;>tvms</span><span>(&now) - </span><span style=color:#bf616a;>tvms</span><span>(&beginTime),
</span><span>  nRequest, </span><span style=color:#bf616a;>Escape</span><span>(zAgent), </span><span style=color:#bf616a;>Escape</span><span>(zRM),
</span><span>  (</span><span style=color:#b48ead;>int</span><span>)(</span><span style=color:#96b5b4;>strlen</span><span>(zHttp)+</span><span style=color:#96b5b4;>strlen</span><span>(zHttpHost)+</span><span style=color:#96b5b4;>strlen</span><span>(zRealScript)+</span><span style=color:#d08770;>3</span><span>),
</span><span>  lineNum
</span><span>);
</span></code></pre><p>Remember the function <code>Escape</code>? This is the ony place where its being used and the pointer returned isn't assigned to anything. So we can't possibly free any of the allocations made.<p>However, just after this, we have:<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#b48ead;>if</span><span>( closeConnection ){
</span><span>  </span><span style=color:#96b5b4;>exit</span><span>(exitCode);
</span><span>}
</span></code></pre><p>Additionally based on the grepped usage of this function above. We saw that most of the time, they immediately exit process. So all those "memory leaks" previously (AFAIK) will be inconsequential.<h3 id=references-1>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/mkstemp.3.html>mkstemp</a><li><a href=https://man7.org/linux/man-pages/man2/unlink.2.html>unlink</a><li><a href=https://man7.org/linux/man-pages/man2/gettimeofday.2.html>gettimeofday</a><li><a href=https://man7.org/linux/man-pages/man3/localtime.3p.html>localtime</a><li><a href=https://man7.org/linux/man-pages/man3/strftime.3.html>strftime</a><li><a href=https://man7.org/linux/man-pages/man3/exit.3.html>exit</a></ol><h1 id=safemalloc>SafeMalloc</h1><p>This function is a wrapper for malloc where it will exit the process if it fails. I think the function itself is self-explanatory. Nothing really interesting is happening here.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Allocate memory safely
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static char </span><span>*</span><span style=color:#8fa1b3;>SafeMalloc</span><span>( size_t </span><span style=color:#bf616a;>size </span><span>){
</span><span>  </span><span style=color:#b48ead;>char </span><span>*p;
</span><span>
</span><span>  p = (</span><span style=color:#b48ead;>char</span><span>*)</span><span style=color:#96b5b4;>malloc</span><span>(size);
</span><span>  </span><span style=color:#b48ead;>if</span><span>( p==</span><span style=color:#d08770;>0 </span><span>){
</span><span>    </span><span style=color:#96b5b4;>strcpy</span><span>(zReplyStatus, "</span><span style=color:#a3be8c;>998</span><span>");
</span><span>    </span><span style=color:#bf616a;>MakeLogEntry</span><span>(</span><span style=color:#d08770;>1</span><span>,</span><span style=color:#d08770;>100</span><span>);  </span><span style=color:#65737e;>/* LOG: Malloc() failed */
</span><span>    </span><span style=color:#96b5b4;>exit</span><span>(</span><span style=color:#d08770;>1</span><span>);
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>return</span><span> p;
</span><span>}
</span></code></pre><h3 id=references-2>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/strcpy.3.html>strcpy</a><li><a href=https://man7.org/linux/man-pages/man3/exit.3.html>exit</a></ol><h1 id=setenv>SetEnv</h1><p>This function sets the environment variables.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Set the value of environment variable zVar to zValue.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>SetEnv</span><span>(</span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zVar</span><span>, </span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zValue</span><span>){
</span><span>  </span><span style=color:#b48ead;>char </span><span>*z;
</span><span>  size_t len;
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zValue==</span><span style=color:#d08770;>0 </span><span>) zValue="";
</span><span>  </span><span style=color:#65737e;>/* Disable an attempted bashdoor attack */
</span><span>  </span><span style=color:#b48ead;>if</span><span>( </span><span style=color:#96b5b4;>strncmp</span><span>(zValue,"</span><span style=color:#a3be8c;>() {</span><span>",</span><span style=color:#d08770;>4</span><span>)==</span><span style=color:#d08770;>0 </span><span>) zValue = "";
</span><span>  len = </span><span style=color:#96b5b4;>strlen</span><span>(zVar) + </span><span style=color:#96b5b4;>strlen</span><span>(zValue) + </span><span style=color:#d08770;>2</span><span>;
</span><span>  z = </span><span style=color:#bf616a;>SafeMalloc</span><span>(len);
</span><span>  </span><span style=color:#96b5b4;>sprintf</span><span>(z,"</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>=</span><span style=color:#d08770;>%s</span><span>",zVar,zValue);
</span><span>  </span><span style=color:#bf616a;>putenv</span><span>(z);
</span><span>}
</span></code></pre><p>There's some issues with this function.<ol><li>It does not free the memory held by <code>z</code>.<li>I think their implementation to prevent <a href=https://en.wikipedia.org/wiki/Shellshock_(software_bug)>bashdoor</a> (Whatever that is) attack is somewhat naive? I am pretty sure one can bypass this check by simply prepending whitespaces.<li>It does not check if <code>zVar</code> is a <code>NULL</code>. Granted, if you grep for its usage, you will find that it only uses statically allocated memory.</ol><pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>bash-3.2$</span><span> rg '</span><span style=color:#a3be8c;>SetEnv</span><span>' ./static/althttpd/althttpd.c
</span><span style=color:#bf616a;>523:static</span><span> void SetEnv(const char *zVar, const char *zValue){
</span><span style=color:#bf616a;>2136:</span><span>        SetEnv(cgienv</span><span style=color:#b48ead;>[</span><span>i</span><span style=color:#b48ead;>]</span><span>.zEnvName,*cgienv</span><span style=color:#b48ead;>[</span><span>i</span><span style=color:#b48ead;>]</span><span>.pzEnvValue);
</span></code></pre><p>The <code>cgienv</code> here is an array of CGI environment variables defined at the top of the file. These are all statically allocated, so no problem here. However, the performance could have been improved in this case by passing the length of the arrays into the function. I am not sure if compilers are smart enough (or allowed to) optimized the call to <code>strlen</code> by evaluating the size at compile time.<h3 id=references-3>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/setenv.3.html>setenv</a></ol><h1 id=getfirstelement>GetFirstElement</h1><p>This function is basically <code>strtok</code> with a slightly different interface. It accepts:<ol><li><code>zInput</code>, the C-string to be tokenized.<li><code>zLeftOver</code>, an output pointer that points to to the leftover C-string.</ol><p>And returns the parsed token.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Remove the first space-delimited token from a string and return
</span><span style=color:#65737e;>** a pointer to it.  Add a NULL to the string to terminate the token.
</span><span style=color:#65737e;>** Make *zLeftOver point to the start of the next token.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static char </span><span>*</span><span style=color:#8fa1b3;>GetFirstElement</span><span>(</span><span style=color:#b48ead;>char </span><span>*</span><span style=color:#bf616a;>zInput</span><span>, </span><span style=color:#b48ead;>char </span><span>**</span><span style=color:#bf616a;>zLeftOver</span><span>){
</span><span>  </span><span style=color:#b48ead;>char </span><span>*zResult = </span><span style=color:#d08770;>0</span><span>;
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zInput==</span><span style=color:#d08770;>0 </span><span>){
</span><span>    </span><span style=color:#b48ead;>if</span><span>( zLeftOver ) *zLeftOver = </span><span style=color:#d08770;>0</span><span>;
</span><span>    </span><span style=color:#b48ead;>return </span><span style=color:#d08770;>0</span><span>;
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>while</span><span>( </span><span style=color:#96b5b4;>isspace</span><span>(*(</span><span style=color:#b48ead;>unsigned char</span><span>*)zInput) ){ zInput++; }
</span><span>  zResult = zInput;
</span><span>  </span><span style=color:#b48ead;>while</span><span>( *zInput && !</span><span style=color:#96b5b4;>isspace</span><span>(*(</span><span style=color:#b48ead;>unsigned char</span><span>*)zInput) ){ zInput++; }
</span><span>  </span><span style=color:#b48ead;>if</span><span>( *zInput ){
</span><span>    *zInput = </span><span style=color:#d08770;>0</span><span>;
</span><span>    zInput++;
</span><span>    </span><span style=color:#b48ead;>while</span><span>( </span><span style=color:#96b5b4;>isspace</span><span>(*(</span><span style=color:#b48ead;>unsigned char</span><span>*)zInput) ){ zInput++; }
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zLeftOver ){ *zLeftOver = zInput; }
</span><span>  </span><span style=color:#b48ead;>return</span><span> zResult;
</span><span>}
</span></code></pre><h3 id=visualization>Visualization</h3><pre style=background-color:#2b303b;color:#c0c5ce;><code><span>h | e | l | l | o | NULL | | | | w | o | r | l | d |
</span><span>|--------------------|-----------|------------------...
</span><span>a                    b           c
</span></code></pre><p>Mark the beginning of the pointer as <code>a</code>. The implementation is similar to <code>strtok</code>, it loops through the string until it encounters a whitespace. It then loop again until it encounters non-whitespace and mark this as <code>c</code>. Assign <code>c</code> to the <code>zLeftOver</code> pointer and returns <code>a</code> as the result. To get the next token, pass <code>zLeftOver</code> token in <code>zInput</code>.<p>Note that because this function will litter the original C-string with <code>NULL</code>s, it will become unusable by <code>strlen</code>. You can audit whether or not the author ever uses <code>strlen</code> on the C-strings that have been passed into this function.<p>Obviously the above algorithm needs to take into consideration the <code>NULL</code> value that marks the end of a C-string.<h3 id=references-4>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/strtok.3.html>strtok</a></ol><h1 id=strdup>StrDup</h1><p>This function basically copies a C-string. Nothing special.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Make a copy of a string into memory obtained from malloc.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static char </span><span>*</span><span style=color:#8fa1b3;>StrDup</span><span>(</span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zSrc</span><span>){
</span><span>  </span><span style=color:#b48ead;>char </span><span>*zDest;
</span><span>  size_t size;
</span><span>
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zSrc==</span><span style=color:#d08770;>0 </span><span>) </span><span style=color:#b48ead;>return </span><span style=color:#d08770;>0</span><span>;
</span><span>  size = </span><span style=color:#96b5b4;>strlen</span><span>(zSrc) + </span><span style=color:#d08770;>1</span><span>;
</span><span>  zDest = (</span><span style=color:#b48ead;>char</span><span>*)</span><span style=color:#bf616a;>SafeMalloc</span><span>( size );
</span><span>  </span><span style=color:#96b5b4;>strcpy</span><span>(zDest,zSrc);
</span><span>  </span><span style=color:#b48ead;>return</span><span> zDest;
</span><span>}
</span></code></pre><p>However, I personally think that using <code>memcpy</code> is better here because we already calculated the string length here.<h3 id=references-5>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/strlen.3.html>strlen</a><li><a href=https://man7.org/linux/man-pages/man3/strcpy.3.html>strcpy</a><li><a href=https://man7.org/linux/man-pages/man3/memcpy.3.html>memcpy</a></ol><h1 id=strappend>StrAppend</h1><p>This function basically takes 3 C-string and concatenates them.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#b48ead;>static char </span><span>*</span><span style=color:#8fa1b3;>StrAppend</span><span>(</span><span style=color:#b48ead;>char </span><span>*</span><span style=color:#bf616a;>zPrior</span><span>, </span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zSep</span><span>, </span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zSrc</span><span>){
</span><span>  </span><span style=color:#b48ead;>char </span><span>*zDest;
</span><span>  size_t size;
</span><span>  size_t n0, n1, n2;
</span><span>
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zSrc==</span><span style=color:#d08770;>0 </span><span>) </span><span style=color:#b48ead;>return </span><span style=color:#d08770;>0</span><span>;
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zPrior==</span><span style=color:#d08770;>0 </span><span>) </span><span style=color:#b48ead;>return </span><span style=color:#bf616a;>StrDup</span><span>(zSrc);
</span><span>  n0 = </span><span style=color:#96b5b4;>strlen</span><span>(zPrior);
</span><span>  n1 = </span><span style=color:#96b5b4;>strlen</span><span>(zSep);
</span><span>  n2 = </span><span style=color:#96b5b4;>strlen</span><span>(zSrc);
</span><span>  size = n0+n1+n2+</span><span style=color:#d08770;>1</span><span>;
</span><span>  zDest = (</span><span style=color:#b48ead;>char</span><span>*)</span><span style=color:#bf616a;>SafeMalloc</span><span>( size );
</span><span>  </span><span style=color:#96b5b4;>memcpy</span><span>(zDest, zPrior, n0);
</span><span>  </span><span style=color:#96b5b4;>free</span><span>(zPrior);
</span><span>  </span><span style=color:#96b5b4;>memcpy</span><span>(&zDest[n0],zSep,n1);
</span><span>  </span><span style=color:#96b5b4;>memcpy</span><span>(&zDest[n0+n1],zSrc,n2+</span><span style=color:#d08770;>1</span><span>);
</span><span>  </span><span style=color:#b48ead;>return</span><span> zDest;
</span><span>}
</span></code></pre><h3 id=visualization-1>Visualization</h3><p>Take 3 C-strings:<ol><li><code>zPrior</code> as <code>hello</code>.<li><code>zSep</code> as <code>my</code>.<li><code>zSrc</code> as <code>world</code>.</ol><p>After this function, we will get something like,<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>h | e | l | l | o |  | m | y | | w | o | r | l | d | NULL |
</span><span>|-----------------|------------|---------------------------...
</span><span><     zPrior      ><    zSep   ><         zSrc          >
</span></code></pre><p>And the original <code>zPrior</code> is freed, for whatever reason.<h3 id=references-6>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/strlen.3.html>strlen</a>.<li><a href=https://man7.org/linux/man-pages/man3/memcpy.3.html>memcpy</a>.<li><a href=https://man7.org/linux/man-pages/man3/free.3p.html>free</a>.</ol><h1 id=compareetags>CompareEtags</h1><p>This function compares 2 C-strings and returns 0 if they differ and non-zero otherwise.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Compare two ETag values. Return 0 if they match and non-zero if they differ.
</span><span style=color:#65737e;>**
</span><span style=color:#65737e;>** The one on the left might be a NULL pointer and it might be quoted.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static int </span><span style=color:#8fa1b3;>CompareEtags</span><span>(</span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zA</span><span>, </span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zB</span><span>){
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zA==</span><span style=color:#d08770;>0 </span><span>) </span><span style=color:#b48ead;>return </span><span style=color:#d08770;>1</span><span>;
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zA[</span><span style=color:#d08770;>0</span><span>]=='</span><span style=color:#a3be8c;>"</span><span>' ){
</span><span>    </span><span style=color:#b48ead;>int</span><span> lenB = (</span><span style=color:#b48ead;>int</span><span>)</span><span style=color:#96b5b4;>strlen</span><span>(zB);
</span><span>    </span><span style=color:#b48ead;>if</span><span>( </span><span style=color:#96b5b4;>strncmp</span><span>(zA+</span><span style=color:#d08770;>1</span><span>, zB, lenB)==</span><span style=color:#d08770;>0 </span><span>&& zA[lenB+</span><span style=color:#d08770;>1</span><span>]=='</span><span style=color:#a3be8c;>"</span><span>' ) </span><span style=color:#b48ead;>return </span><span style=color:#d08770;>0</span><span>;
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>return </span><span style=color:#96b5b4;>strcmp</span><span>(zA, zB);
</span><span>}
</span></code></pre><p>Notice that the function never checks the length of <code>lenB</code>, so it might seem problematic that we perform an arbitrary index <code>zA[lenB + 1]</code> here. I think this is totally safe because the check is implicitly done by the fact that:<ol><li>All C-strings ends with a <code>NULL</code>. This is kind of hard to verify.<li>In the <code>if</code> logic, we will only evaluate the right-hand side iff the call to <code>strncmp</code>here succeed. This means that <code>zA</code> is at least as long as <code>lenB</code>. Coupled with the fact that its a C-string, we can be sure that there's at least <em>another</em> character beyond that, namely the <code>NULL</code> character.</ol><h3 id=references-7>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/strlen.3.html>strlen</a>.<li><a href=https://man7.org/linux/man-pages/man3/strncmp.3p.html>strncmp</a>.</ol><h1 id=removenewline>RemoveNewline</h1><p>This function replaces newline (<code>\n</code> or <code>\r</code>) with <code>NULL</code>.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Break a line at the first \n or \r character seen.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>RemoveNewline</span><span>(</span><span style=color:#b48ead;>char </span><span>*</span><span style=color:#bf616a;>z</span><span>){
</span><span>  </span><span style=color:#b48ead;>if</span><span>( z==</span><span style=color:#d08770;>0 </span><span>) </span><span style=color:#b48ead;>return</span><span>;
</span><span>  </span><span style=color:#b48ead;>while</span><span>( *z && *z!='</span><span style=color:#96b5b4;>\n</span><span>' && *z!='</span><span style=color:#96b5b4;>\r</span><span>' ){ z++; }
</span><span>  *z = </span><span style=color:#d08770;>0</span><span>;
</span><span>}
</span></code></pre><p>This is probably done so that C-string appears as if it ends there. But this is highly problematic because it does not return the <code>z</code>. The caller have no way of knowing where that <code>NULL</code> was assigned. Even if they loop through again and find that <code>NULL</code>, how do they know that this <code>NULL</code> is the one that we assigned or this is the <em>actual</em> the end of the C-string?<p>In my opinion, it should return the pointer to the next character if its part of the C-string.<h1 id=rfc822date>Rfc822Date</h1><p>This function converts a <code>time_t</code> into its RFC822 representation.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/* Render seconds since 1970 as an RFC822 date string.  Return
</span><span style=color:#65737e;>** a pointer to that string in a static buffer.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static char </span><span>*</span><span style=color:#8fa1b3;>Rfc822Date</span><span>(time_t </span><span style=color:#bf616a;>t</span><span>){
</span><span>  </span><span style=color:#b48ead;>struct</span><span> tm *tm;
</span><span>  </span><span style=color:#b48ead;>static char</span><span> zDate[</span><span style=color:#d08770;>100</span><span>];
</span><span>  tm = </span><span style=color:#96b5b4;>gmtime</span><span>(&t);
</span><span>  </span><span style=color:#96b5b4;>strftime</span><span>(zDate, sizeof(zDate), "</span><span style=color:#d08770;>%a</span><span style=color:#a3be8c;>, </span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;> %b %Y %H:%M:</span><span style=color:#d08770;>%S</span><span style=color:#a3be8c;> %Z</span><span>", tm);
</span><span>  </span><span style=color:#b48ead;>return</span><span> zDate;
</span><span>}
</span></code></pre><p>The interesting (in a bad way) is that it returns a pointer to a statically allocated memory. So any time you make 2 calls to this bad boy, just remember that the first pointer returned is now invalid :).<p>One way to solve this is to make the caller of this function provides the bytes to write to. This makes this function free from being responsible for memory; which it shouldn't.<h3 id=testing>Testing</h3><p>Let's try to use this function and see what we get.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#b48ead;>#include </span><span><</span><span style=color:#a3be8c;>stdio.h</span><span>>
</span><span style=color:#b48ead;>#include </span><span><</span><span style=color:#a3be8c;>time.h</span><span>>
</span><span>
</span><span style=color:#b48ead;>static char </span><span>*</span><span style=color:#8fa1b3;>Rfc822Date</span><span>(time_t </span><span style=color:#bf616a;>t</span><span>)
</span><span>{
</span><span>    </span><span style=color:#b48ead;>struct</span><span> tm *tm;
</span><span>    </span><span style=color:#b48ead;>static char</span><span> zDate[</span><span style=color:#d08770;>100</span><span>];
</span><span>    tm = </span><span style=color:#96b5b4;>gmtime</span><span>(&t);
</span><span>    </span><span style=color:#96b5b4;>strftime</span><span>(zDate, sizeof(zDate), "</span><span style=color:#d08770;>%a</span><span style=color:#a3be8c;>, </span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;> %b %Y %H:%M:</span><span style=color:#d08770;>%S</span><span style=color:#a3be8c;> %Z</span><span>", tm);
</span><span>    </span><span style=color:#b48ead;>return</span><span> zDate;
</span><span>}
</span><span>
</span><span style=color:#b48ead;>int </span><span style=color:#8fa1b3;>main</span><span>(</span><span style=color:#b48ead;>void</span><span>)
</span><span>{
</span><span>    time_t t = </span><span style=color:#96b5b4;>time</span><span>(</span><span style=color:#d08770;>NULL</span><span>);
</span><span>    </span><span style=color:#b48ead;>char </span><span>*zDate = </span><span style=color:#bf616a;>Rfc822Date</span><span>(t);
</span><span>    </span><span style=color:#b48ead;>const int</span><span> r = </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\r\n</span><span>", zDate);
</span><span>    </span><span style=color:#b48ead;>return</span><span> r < </span><span style=color:#d08770;>0 </span><span>? -</span><span style=color:#d08770;>1 </span><span>: </span><span style=color:#d08770;>0</span><span>;
</span><span>}
</span></code></pre><p>Compiling and running this small program yields,<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>Sat,</span><span> 12 Jun 2021 16:24:15 GMT
</span></code></pre><h3 id=references-8>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/strftime.3.html>strftime</a><li><a href=https://man7.org/linux/man-pages/man3/gmtime.3p.html>gmtime</a></ol><h1 id=datetag>DateTag</h1><p>Nothing really special about this function. It just appends the <code>zTag</code> and the <code>Rfc822Date</code> of the given time. The result is then printed to <code>stdout</code>.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Print a date tag in the header.  The name of the tag is zTag.
</span><span style=color:#65737e;>** The date is determined from the unix timestamp given.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static int </span><span style=color:#8fa1b3;>DateTag</span><span>(</span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zTag</span><span>, time_t </span><span style=color:#bf616a;>t</span><span>){
</span><span>  </span><span style=color:#b48ead;>return </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>: </span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\r\n</span><span>", zTag, </span><span style=color:#bf616a;>Rfc822Date</span><span>(t));
</span><span>}
</span></code></pre><h3 id=references-9>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/printf.3.html>printf</a></ol><h1 id=parserfc822date>ParseRfc822Date</h1><p>This function is quite complicated. I don't pretend to know half of how it works. However, as the comment said, its supposed to parse an RFC822 formatted strings. It just appends the <code>zTag</code> and the <code>Rfc822Date</code> of the given time.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Parse an RFC822-formatted timestamp as we'd expect from HTTP and return
</span><span style=color:#65737e;>** a Unix epoch time. <= zero is returned on failure.
</span><span style=color:#65737e;>*/
</span><span>time_t </span><span style=color:#8fa1b3;>ParseRfc822Date</span><span>(</span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zDate</span><span>){
</span><span>  </span><span style=color:#b48ead;>int</span><span> mday, mon, year, yday, hour, min, sec;
</span><span>  </span><span style=color:#b48ead;>char</span><span> zIgnore[</span><span style=color:#d08770;>4</span><span>];
</span><span>  </span><span style=color:#b48ead;>char</span><span> zMonth[</span><span style=color:#d08770;>4</span><span>];
</span><span>  </span><span style=color:#b48ead;>static const char </span><span>*</span><span style=color:#b48ead;>const</span><span> azMonths[] =
</span><span>    {"</span><span style=color:#a3be8c;>Jan</span><span>", "</span><span style=color:#a3be8c;>Feb</span><span>", "</span><span style=color:#a3be8c;>Mar</span><span>", "</span><span style=color:#a3be8c;>Apr</span><span>", "</span><span style=color:#a3be8c;>May</span><span>", "</span><span style=color:#a3be8c;>Jun</span><span>",
</span><span>     "</span><span style=color:#a3be8c;>Jul</span><span>", "</span><span style=color:#a3be8c;>Aug</span><span>", "</span><span style=color:#a3be8c;>Sep</span><span>", "</span><span style=color:#a3be8c;>Oct</span><span>", "</span><span style=color:#a3be8c;>Nov</span><span>", "</span><span style=color:#a3be8c;>Dec</span><span>"};
</span><span>  </span><span style=color:#b48ead;>if</span><span>( </span><span style=color:#d08770;>7</span><span>==</span><span style=color:#96b5b4;>sscanf</span><span>(zDate, "</span><span style=color:#d08770;>%3[A-Za-z]</span><span style=color:#a3be8c;>, </span><span style=color:#d08770;>%d %3[A-Za-z] %d %d</span><span style=color:#a3be8c;>:</span><span style=color:#d08770;>%d</span><span style=color:#a3be8c;>:</span><span style=color:#d08770;>%d</span><span>", zIgnore,
</span><span>                       &mday, zMonth, &year, &hour, &min, &sec)){
</span><span>    </span><span style=color:#b48ead;>if</span><span>( year > </span><span style=color:#d08770;>1900 </span><span>) year -= </span><span style=color:#d08770;>1900</span><span>;
</span><span>    </span><span style=color:#b48ead;>for</span><span>(mon=</span><span style=color:#d08770;>0</span><span>; mon<</span><span style=color:#d08770;>12</span><span>; mon++){
</span><span>      </span><span style=color:#b48ead;>if</span><span>( !</span><span style=color:#96b5b4;>strncmp</span><span>( azMonths[mon], zMonth, </span><span style=color:#d08770;>3 </span><span>)){
</span><span>        </span><span style=color:#b48ead;>int</span><span> nDay;
</span><span>        </span><span style=color:#b48ead;>int</span><span> isLeapYr;
</span><span>        </span><span style=color:#b48ead;>static int</span><span> priorDays[] =
</span><span>         {  </span><span style=color:#d08770;>0</span><span>, </span><span style=color:#d08770;>31</span><span>, </span><span style=color:#d08770;>59</span><span>, </span><span style=color:#d08770;>90</span><span>,</span><span style=color:#d08770;>120</span><span>,</span><span style=color:#d08770;>151</span><span>,</span><span style=color:#d08770;>181</span><span>,</span><span style=color:#d08770;>212</span><span>,</span><span style=color:#d08770;>243</span><span>,</span><span style=color:#d08770;>273</span><span>,</span><span style=color:#d08770;>304</span><span>,</span><span style=color:#d08770;>334 </span><span>};
</span><span>        isLeapYr = year%</span><span style=color:#d08770;>4</span><span>==</span><span style=color:#d08770;>0 </span><span>&& (year%</span><span style=color:#d08770;>100</span><span>!=</span><span style=color:#d08770;>0 </span><span>|| (year+</span><span style=color:#d08770;>300</span><span>)%</span><span style=color:#d08770;>400</span><span>==</span><span style=color:#d08770;>0</span><span>);
</span><span>        yday = priorDays[mon] + mday - </span><span style=color:#d08770;>1</span><span>;
</span><span>        </span><span style=color:#b48ead;>if</span><span>( isLeapYr && mon></span><span style=color:#d08770;>1 </span><span>) yday++;
</span><span>        nDay = (year-</span><span style=color:#d08770;>70</span><span>)*</span><span style=color:#d08770;>365 </span><span>+ (year-</span><span style=color:#d08770;>69</span><span>)/</span><span style=color:#d08770;>4 </span><span>- year/</span><span style=color:#d08770;>100 </span><span>+ (year+</span><span style=color:#d08770;>300</span><span>)/</span><span style=color:#d08770;>400 </span><span>+ yday;
</span><span>        </span><span style=color:#b48ead;>return </span><span>((time_t)(nDay*</span><span style=color:#d08770;>24 </span><span>+ hour)*</span><span style=color:#d08770;>60 </span><span>+ min)*</span><span style=color:#d08770;>60 </span><span>+ sec;
</span><span>      }
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>return </span><span style=color:#d08770;>0</span><span>;
</span><span>}
</span></code></pre><p>Given how complex the notion of timezones and time itself, I bet this function is broken. Its much easier to just rely on the standard libc function --- and likely more reliable. See the <a href=../althttpd/c_time_back_and_forth.c>C code here</a> to see parsing dates back and forth,<h3 id=references-10>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/gmtime.3p.html>gmtime</a><li><a href=https://man7.org/linux/man-pages/man3/strftime.3.html>strftime</a><li><a href=https://man7.org/linux/man-pages/man3/strptime.3.html>strptime</a><li><a href=https://man7.org/linux/man-pages/man3/time.3p.html>time</a><li><a href=https://man7.org/linux/man-pages/man3/memset.3.html>memset</a><li><a href=https://man7.org/linux/man-pages/man3/memcmp.3p.html>memcmp</a></ol><h1 id=testparserfc822date>TestParseRfc822Date</h1><p>This function only exists for testing purposes. I wonder how plausible it is to test <em>all</em> the possible values by forking a bunch of process...<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Test procedure for ParseRfc822Date
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>void </span><span style=color:#8fa1b3;>TestParseRfc822Date</span><span>(</span><span style=color:#b48ead;>void</span><span>){
</span><span>  time_t t1, t2;
</span><span>  </span><span style=color:#b48ead;>for</span><span>(t1=</span><span style=color:#d08770;>0</span><span>; t1<</span><span style=color:#d08770;>0x7fffffff</span><span>; t1 += </span><span style=color:#d08770;>127</span><span>){
</span><span>    t2 = </span><span style=color:#bf616a;>ParseRfc822Date</span><span>(</span><span style=color:#bf616a;>Rfc822Date</span><span>(t1));
</span><span>    </span><span style=color:#96b5b4;>assert</span><span>( t1==t2 );
</span><span>  }
</span><span>}
</span></code></pre><p>To show that its only used once,<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina.github.io</span><span> on  master </span><span style=color:#b48ead;>[</span><span>?</span><span style=color:#b48ead;>]
</span><span style=color:#bf616a;></span><span> cat ./static/althttpd/althttpd.c | </span><span style=color:#bf616a;>rg --line-number </span><span>'</span><span style=color:#a3be8c;>TestParseRfc822Date</span><span>'
</span><span style=color:#bf616a;>666:void</span><span> TestParseRfc822Date(void){
</span><span style=color:#bf616a;>2425:</span><span>      TestParseRfc822Date();
</span></code></pre><h3 id=references-11>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/assert.3.html>assert</a></ol><h1 id=startresponse>StartResponse</h1><p>The way this program generates the response to HTTP requests is by printing to <code>stdout</code>. This function will setup the HTTP request header with the protocol and the status. It will also do some additional stuff based on the status response.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Print the first line of a response followed by the server type.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>StartResponse</span><span>(</span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zResultCode</span><span>){
</span><span>  time_t now;
</span><span>  </span><span style=color:#96b5b4;>time</span><span>(&now);
</span><span>  </span><span style=color:#b48ead;>if</span><span>( statusSent ) </span><span style=color:#b48ead;>return</span><span>;
</span><span>  nOut += </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#d08770;>%s %s</span><span style=color:#96b5b4;>\r\n</span><span>", zProtocol, zResultCode);
</span><span>  </span><span style=color:#96b5b4;>strncpy</span><span>(zReplyStatus, zResultCode, </span><span style=color:#d08770;>3</span><span>);
</span><span>  zReplyStatus[</span><span style=color:#d08770;>3</span><span>] = </span><span style=color:#d08770;>0</span><span>;
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zReplyStatus[</span><span style=color:#d08770;>0</span><span>]>='</span><span style=color:#a3be8c;>4</span><span>' ){
</span><span>    closeConnection = </span><span style=color:#d08770;>1</span><span>;
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>if</span><span>( closeConnection ){
</span><span>    nOut += </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#a3be8c;>Connection: close</span><span style=color:#96b5b4;>\r\n</span><span>");
</span><span>  }</span><span style=color:#b48ead;>else</span><span>{
</span><span>    nOut += </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#a3be8c;>Connection: keep-alive</span><span style=color:#96b5b4;>\r\n</span><span>");
</span><span>  }
</span><span>  nOut += </span><span style=color:#bf616a;>DateTag</span><span>("</span><span style=color:#a3be8c;>Date</span><span>", now);
</span><span>  statusSent = </span><span style=color:#d08770;>1</span><span>;
</span><span>}
</span></code></pre><p>One thing to notice that is that if the first digit in the reply status is <code>>=4</code>, it will append the HTTP header with <code>Connection: close</code>. It probably means that if there's <em>any</em> issue with the request, the server will just close the connection.<p>Let's see how its being used,<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina.github.io</span><span> on  master </span><span style=color:#b48ead;>[</span><span>!?</span><span style=color:#b48ead;>]
</span><span style=color:#bf616a;></span><span> cat ./static/althttpd/althttpd.c | </span><span style=color:#bf616a;>rg --line-number </span><span>'</span><span style=color:#a3be8c;>StartResponse</span><span>'
</span><span style=color:#bf616a;>677:static</span><span> void StartResponse(const char *zResultCode){
</span><span style=color:#bf616a;>700:</span><span>  StartResponse("</span><span style=color:#a3be8c;>404 Not Found</span><span>");
</span><span style=color:#bf616a;>716:</span><span>  StartResponse("</span><span style=color:#a3be8c;>403 Forbidden</span><span>");
</span><span style=color:#bf616a;>732:</span><span>  StartResponse("</span><span style=color:#a3be8c;>401 Authorization Required</span><span>");
</span><span style=color:#bf616a;>748:</span><span>  StartResponse("</span><span style=color:#a3be8c;>500 Error</span><span>");
</span><span style=color:#bf616a;>783:</span><span>  StartResponse("</span><span style=color:#a3be8c;>500 CGI Configuration Error</span><span>");
</span><span style=color:#bf616a;>799:</span><span>  StartResponse("</span><span style=color:#a3be8c;>500 Server Malfunction</span><span>");
</span><span style=color:#bf616a;>821:</span><span>      StartResponse("</span><span style=color:#a3be8c;>301 Permanent Redirect</span><span>");
</span><span style=color:#bf616a;>824:</span><span>      StartResponse("</span><span style=color:#a3be8c;>308 Permanent Redirect</span><span>");
</span><span style=color:#bf616a;>827:</span><span>      StartResponse("</span><span style=color:#a3be8c;>302 Temporary Redirect</span><span>");
</span><span style=color:#bf616a;>1317:</span><span>    StartResponse("</span><span style=color:#a3be8c;>304 Not Modified</span><span>");
</span><span style=color:#bf616a;>1329:</span><span>    StartResponse("</span><span style=color:#a3be8c;>206 Partial Content</span><span>");
</span><span style=color:#bf616a;>1337:</span><span>    StartResponse("</span><span style=color:#a3be8c;>200 OK</span><span>");
</span><span style=color:#bf616a;>1389:</span><span>      StartResponse("</span><span style=color:#a3be8c;>302 Redirect</span><span>");
</span><span style=color:#bf616a;>1424:</span><span>    StartResponse("</span><span style=color:#a3be8c;>206 Partial Content</span><span>");
</span><span style=color:#bf616a;>1432:</span><span>    StartResponse("</span><span style=color:#a3be8c;>200 OK</span><span>");
</span><span style=color:#bf616a;>1678:</span><span>    StartResponse("</span><span style=color:#a3be8c;>400 Bad Request</span><span>");
</span><span style=color:#bf616a;>1703:</span><span>    StartResponse("</span><span style=color:#a3be8c;>501 Not Implemented</span><span>");
</span><span style=color:#bf616a;>1902:</span><span>      StartResponse("</span><span style=color:#a3be8c;>500 Request too large</span><span>");
</span><span style=color:#bf616a;>1920:</span><span>      StartResponse("</span><span style=color:#a3be8c;>500 Cannot create /tmp file</span><span>");
</span></code></pre><p>As you can see, these are all HTTP headers. All of them are also statically allocated, I think its worth creating a list of possible HTTP headers and use that. Some extra safety!<p>Another interesting to note is that if the browser uses <code>HTTP/2</code>, this response header can/should be considered malformed according to the <a href=https://datatracker.ietf.org/doc/html/rfc7540#section-8.1.2.2>spec</a>.<h3 id=references-12>References</h3><ol><li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Messages#http_responses>HTTP Response Header</a></ol><h1 id=notfound>NotFound</h1><p>This is just a generic "404 NOT FOUND" template. The only 2 values that it need to complete the document is:<ol><li><code>lineno</code> which depends on the caller of this function. As I said in previous entries, I think every compiler have a C macro for this already.<li><code>zScript</code> which is the document that the user is attempting to retrieve. This is probably the string after the domain in the URL.</ol><pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Tell the client that there is no such document
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>NotFound</span><span>(</span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>lineno</span><span>){
</span><span>  </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>404 Not Found</span><span>");
</span><span>  nOut += </span><span style=color:#96b5b4;>printf</span><span>(
</span><span>    "</span><span style=color:#a3be8c;>Content-type: text/html; charset=utf-8</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>&LThead>&LTtitle lineno=</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%d</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>>Not Found&LT/title>&LT/head></span><span style=color:#96b5b4;>\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>&LTbody>&LTh1>Document Not Found&LT/h1></span><span style=color:#96b5b4;>\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>The document </span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;> is not available on this server</span><span style=color:#96b5b4;>\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>&LT/body></span><span style=color:#96b5b4;>\n</span><span>", lineno, zScript);
</span><span>  </span><span style=color:#bf616a;>MakeLogEntry</span><span>(</span><span style=color:#d08770;>0</span><span>, lineno);
</span><span>  </span><span style=color:#96b5b4;>exit</span><span>(</span><span style=color:#d08770;>0</span><span>);
</span><span>}
</span></code></pre><p>Note that before ending the process, it will create a log entry. It's used in quite a few places,<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina.github.io</span><span> on  master </span><span style=color:#b48ead;>[</span><span>!?</span><span style=color:#b48ead;>]
</span><span style=color:#bf616a;></span><span> cat static/althttpd/althttpd.c | </span><span style=color:#bf616a;>rg --line-number </span><span>'</span><span style=color:#a3be8c;>NotFound</span><span>'
</span><span style=color:#bf616a;>699:static</span><span> void NotFound(int lineno){
</span><span style=color:#bf616a;>917:</span><span>    NotFound(150);  </span><span style=color:#bf616a;>/*</span><span> LOG: Cannot open</span><span style=color:#bf616a;> -auth</span><span> file */
</span><span style=color:#bf616a;>943:</span><span>        NotFound(160);  </span><span style=color:#bf616a;>/*</span><span> LOG:  http request on https-only page */
</span><span style=color:#bf616a;>958:</span><span>      NotFound(180);  </span><span style=color:#bf616a;>/*</span><span> LOG:  malformed entry in</span><span style=color:#bf616a;> -auth</span><span> file */
</span><span style=color:#bf616a;>1327:</span><span>  if( in==0 ) </span><span style=color:#bf616a;>NotFound</span><span>(480); </span><span style=color:#bf616a;>/*</span><span> LOG: fopen() </span><span style=color:#bf616a;>failed</span><span> for static content */
</span><span style=color:#bf616a;>1687:</span><span>  if( zScript</span><span style=color:#b48ead;>[</span><span>0</span><span style=color:#b48ead;>]</span><span>!='</span><span style=color:#a3be8c;>/</span><span>' ) </span><span style=color:#bf616a;>NotFound</span><span>(210); </span><span style=color:#bf616a;>/*</span><span> LOG: Empty request URI */
</span><span style=color:#bf616a;>1860:</span><span>        NotFound(260);  </span><span style=color:#bf616a;>/*</span><span> LOG: Disallowed referrer */
</span><span style=color:#bf616a;>1962:</span><span>      NotFound(300); </span><span style=color:#bf616a;>/*</span><span> LOG: Path element begins with "</span><span style=color:#a3be8c;>.</span><span>" or "</span><span style=color:#a3be8c;>-</span><span>" */
</span><span style=color:#bf616a;>1974:</span><span>    NotFound(310); </span><span style=color:#bf616a;>/*</span><span> LOG: URI does not start with "</span><span style=color:#a3be8c;>/</span><span>" */
</span><span style=color:#bf616a;>1977:</span><span>    NotFound(320); </span><span style=color:#bf616a;>/*</span><span> LOG: URI too long */
</span><span style=color:#bf616a;>1980:</span><span>    NotFound(330);  </span><span style=color:#bf616a;>/*</span><span> LOG: Missing HOST: parameter */
</span><span style=color:#bf616a;>1982:</span><span>    NotFound(340);  </span><span style=color:#bf616a;>/*</span><span> LOG: HOST parameter too long */
</span><span style=color:#bf616a;>2007:</span><span>        NotFound(350);  </span><span style=color:#bf616a;>/*</span><span> LOG: *.website permissions */
</span><span style=color:#bf616a;>2049:</span><span>      if( stillSearching ) </span><span style=color:#bf616a;>NotFound</span><span>(380); </span><span style=color:#bf616a;>/*</span><span> LOG: URI not found */
</span><span style=color:#bf616a;>2054:</span><span>        NotFound(390);  </span><span style=color:#bf616a;>/*</span><span> LOG: File not readable */
</span><span style=color:#bf616a;>2071:</span><span>        NotFound(400); </span><span style=color:#bf616a;>/*</span><span> LOG: URI is a directory w/o index.html */
</span><span style=color:#bf616a;>2211:</span><span>    NotFound(460); </span><span style=color:#bf616a;>/*</span><span> LOG: Excess URI content past static file name */
</span></code></pre><h3 id=references-13>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/printf.3.html>printf</a><li><a href=https://man7.org/linux/man-pages/man3/exit.3.html>exit</a></ol><h1 id=forbidden>Forbidden</h1><p>Another HTTP response template. This time its to indicate that the request is forbidden.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Tell the client that they are not welcomed here.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>Forbidden</span><span>(</span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>lineno</span><span>){
</span><span>  </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>403 Forbidden</span><span>");
</span><span>  nOut += </span><span style=color:#96b5b4;>printf</span><span>(
</span><span>    "</span><span style=color:#a3be8c;>Content-type: text/plain; charset=utf-8</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>Access denied</span><span style=color:#96b5b4;>\n</span><span>"
</span><span>  );
</span><span>  closeConnection = </span><span style=color:#d08770;>1</span><span>;
</span><span>  </span><span style=color:#bf616a;>MakeLogEntry</span><span>(</span><span style=color:#d08770;>0</span><span>, lineno);
</span><span>  </span><span style=color:#96b5b4;>exit</span><span>(</span><span style=color:#d08770;>0</span><span>);
</span><span>}
</span></code></pre><h3 id=what-is-forbidden>What is Forbidden?</h3><p>I think its amusing to look at the usage of this function. It's being used at several places,<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span>hbina.</span><span style=color:#bf616a;>github</span><span>.</span><span style=color:#bf616a;>io</span><span> on  master took </span><span style=color:#d08770;>4</span><span style=background-color:#bf616a;color:#2b303b;>s</span><span>
</span><span> cat ./</span><span style=color:#b48ead;>static</span><span>/althttpd/althttpd.</span><span style=color:#bf616a;>c </span><span>| rg --line-number '</span><span style=color:#a3be8c;>Forbidden</span><span>'
</span><span style=color:#d08770;>715</span><span>:</span><span style=color:#b48ead;>static void </span><span style=color:#bf616a;>Forbidden</span><span>(</span><span style=color:#b48ead;>int</span><span> lineno){
</span><span style=color:#d08770;>716</span><span>:  </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>403 Forbidden</span><span>");
</span><span style=color:#d08770;>1764</span><span>:        </span><span style=color:#bf616a;>Forbidden</span><span>(</span><span style=color:#d08770;>230</span><span>); </span><span style=color:#65737e;>/* LOG: Referrer is devids.net */
</span><span style=color:#d08770;>1778</span><span>:        </span><span style=color:#bf616a;>Forbidden</span><span>(</span><span style=color:#d08770;>240</span><span>);  </span><span style=color:#65737e;>/* LOG: Illegal content in HOST: parameter */
</span><span style=color:#d08770;>1838</span><span>:        </span><span style=color:#bf616a;>Forbidden</span><span>(</span><span style=color:#d08770;>250</span><span>);  </span><span style=color:#65737e;>/* LOG: Disallowed user agent */
</span><span style=color:#d08770;>1846</span><span>:      </span><span style=color:#bf616a;>Forbidden</span><span>(</span><span style=color:#d08770;>251</span><span>);  </span><span style=color:#65737e;>/* LOG: Disallowed user agent (20190424) */
</span></code></pre><h4 id=forbidden-referer>Forbidden Referer</h4><p>HTTP headers have a "referer" value when making requests so that the server can know who made the request. For whatever reason, the author decides to forbid anyone from <code>devids.net</code>!<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span>    </span><span style=background-color:#bf616a;color:#2b303b;>}</span><span style=color:#b48ead;>else if</span><span>( </span><span style=color:#bf616a;>strcasecmp</span><span>(zFieldName,"</span><span style=color:#a3be8c;>Referer:</span><span>")==</span><span style=color:#d08770;>0 </span><span>){
</span><span>      zReferer = </span><span style=color:#bf616a;>StrDup</span><span>(zVal);
</span><span>      </span><span style=color:#b48ead;>if</span><span>( </span><span style=color:#96b5b4;>strstr</span><span>(zVal, "</span><span style=color:#a3be8c;>devids.net/</span><span>")!=</span><span style=color:#d08770;>0 </span><span>){ zReferer = "</span><span style=color:#a3be8c;>devids.net.smut</span><span>";
</span><span>        </span><span style=color:#bf616a;>Forbidden</span><span>(</span><span style=color:#d08770;>230</span><span>); </span><span style=color:#65737e;>/* LOG: Referrer is devids.net */
</span><span>      }
</span></code></pre><h4 id=forbidden-host>Forbidden Host</h4><p>When parsing the <code>Host</code> header value, the server will also reply with forbidden if there's illegal content in it. We will cover what <code>sanitizeString</code> is later.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span>    </span><span style=background-color:#bf616a;color:#2b303b;>}</span><span style=color:#b48ead;>else if</span><span>( </span><span style=color:#bf616a;>strcasecmp</span><span>(zFieldName,"</span><span style=color:#a3be8c;>Host:</span><span>")==</span><span style=color:#d08770;>0 </span><span>){
</span><span>      </span><span style=color:#b48ead;>int</span><span> inSquare = </span><span style=color:#d08770;>0</span><span>;
</span><span>      </span><span style=color:#b48ead;>char</span><span> c;
</span><span>      </span><span style=color:#b48ead;>if</span><span>( </span><span style=color:#bf616a;>sanitizeString</span><span>(zVal) ){
</span><span>        </span><span style=color:#bf616a;>Forbidden</span><span>(</span><span style=color:#d08770;>240</span><span>);  </span><span style=color:#65737e;>/* LOG: Illegal content in HOST: parameter */
</span><span>      }
</span></code></pre><h4 id=forbidden-agents>Forbidden Agents</h4><p>There's also a list of disallowed agents. I am not sure why half of these are in here... I guess its just what the author had accumulated after over 20 years of running this program.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#b48ead;>if</span><span>( zAgent ){
</span><span>    </span><span style=color:#b48ead;>const char </span><span>*azDisallow[] = {
</span><span>      "</span><span style=color:#a3be8c;>Windows 9</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>Download Master</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>Ezooms/</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>HTTrace</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>AhrefsBot</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>MicroMessenger</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>OPPO A33 Build</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>SemrushBot</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>MegaIndex.ru</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>MJ12bot</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>Chrome/0.A.B.C</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>Neevabot/</span><span>",
</span><span>      "</span><span style=color:#a3be8c;>BLEXBot/</span><span>",
</span><span>    };
</span><span>    size_t ii;
</span><span>    </span><span style=color:#b48ead;>for</span><span>(ii=</span><span style=color:#d08770;>0</span><span>; ii&LTsizeof(azDisallow)/sizeof(azDisallow[</span><span style=color:#d08770;>0</span><span>]); ii++){
</span><span>      </span><span style=color:#b48ead;>if</span><span>( </span><span style=color:#96b5b4;>strstr</span><span>(zAgent,azDisallow[ii])!=</span><span style=color:#d08770;>0 </span><span>){
</span><span>        </span><span style=color:#bf616a;>Forbidden</span><span>(</span><span style=color:#d08770;>250</span><span>);  </span><span style=color:#65737e;>/* LOG: Disallowed user agent */
</span><span>      }
</span><span>    }
</span></code></pre><h4 id=forbidden-spiders>Forbidden Spiders</h4><p>This one is disabled and its actually quite new! I am not sure what this is? I suppose there's a specific misbehaving/malicious website crawler attack the author's server at that time.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#b48ead;>#if </span><span style=color:#d08770;>0
</span><span style=color:#65737e;>    /* Spider attack from 2019-04-24 */
</span><span style=color:#65737e;>    if( strcmp(zAgent,
</span><span style=color:#65737e;>            "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 "
</span><span style=color:#65737e;>            "(KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36")==0 ){
</span><span style=color:#65737e;>      Forbidden(251);  /* LOG: Disallowed user agent (20190424) */
</span><span style=color:#65737e;>    }
</span><span style=color:#b48ead;>#endif
</span></code></pre><h3 id=references-14>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/printf.3.html>printf</a>.<li><a href=https://man7.org/linux/man-pages/man3/exit.3.html>exit</a>.<li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer>HTTP Header Referer</a>.<li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host>HTTP Header Host</a>.<li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent>HTTP Header User-Agent</a>.</ol><h1 id=notauthorized>NotAuthorized</h1><p>Yet another HTTP response template. This time its to indicate that the request is unauthorised to access that resource.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Tell the client that authorization is required to access the
</span><span style=color:#65737e;>** document.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>NotAuthorized</span><span>(</span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zRealm</span><span>){
</span><span>  </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>401 Authorization Required</span><span>");
</span><span>  nOut += </span><span style=color:#96b5b4;>printf</span><span>(
</span><span>    "</span><span style=color:#a3be8c;>WWW-Authenticate: Basic realm=</span><span style=color:#96b5b4;>\"</span><span style=color:#d08770;>%s</span><span style=color:#96b5b4;>\"\r\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>Content-type: text/html; charset=utf-8</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>&LThead>&LTtitle>Not Authorized&LT/title>&LT/head></span><span style=color:#96b5b4;>\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>&LTbody>&LTh1>401 Not Authorized&LT/h1></span><span style=color:#96b5b4;>\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>A login and password are required for this document</span><span style=color:#96b5b4;>\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>&LT/body></span><span style=color:#96b5b4;>\n</span><span>", zRealm);
</span><span>  </span><span style=color:#bf616a;>MakeLogEntry</span><span>(</span><span style=color:#d08770;>0</span><span>, </span><span style=color:#d08770;>110</span><span>);  </span><span style=color:#65737e;>/* LOG: Not authorized */
</span><span>}
</span></code></pre><p>There's nothing much to be said about this function. So let's take a look at its usage. There's only 1 of them.<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina.github.io</span><span> on  master </span><span style=color:#b48ead;>[</span><span>?</span><span style=color:#b48ead;>]
</span><span style=color:#bf616a;></span><span> cat ./static/althttpd/althttpd.c | </span><span style=color:#bf616a;>rg --line-number </span><span>'</span><span style=color:#a3be8c;>NotAuthorized</span><span>'
</span><span style=color:#bf616a;>731:static</span><span> void NotAuthorized(const char *zRealm){
</span><span style=color:#bf616a;>964:</span><span>  NotAuthorized(zRealm);
</span></code></pre><h3 id=configuring-authorization>Configuring Authorization</h3><p>The function that made the call is <code>CheckBasicAuthorization</code>. This function parses an authorization file that may or may not exist in the directory that the resources is in. One of the parameters that can be added in this configuration file is <code>realm</code>. The documentation says,<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span>**    *  "</span><span style=color:#a3be8c;>realm TEXT</span><span>" sets the realm to TEXT.
</span></code></pre><p>So while parsing this configuration file, we assign the "<code>TEXT</code>" above to <code>zRealm</code> here,<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span>    </span><span style=color:#b48ead;>if</span><span>( </span><span style=color:#96b5b4;>strcmp</span><span>(zFieldName, "</span><span style=color:#a3be8c;>realm</span><span>")==</span><span style=color:#d08770;>0 </span><span>){
</span><span>      zRealm = </span><span style=color:#bf616a;>StrDup</span><span>(zVal);
</span></code></pre><p>But <code>zRealm</code> is never used!<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina.github.io</span><span> on  master </span><span style=color:#b48ead;>[</span><span>?</span><span style=color:#b48ead;>]
</span><span style=color:#bf616a;></span><span> cat ./static/althttpd/althttpd.c | </span><span style=color:#bf616a;>rg --line-number </span><span>'</span><span style=color:#a3be8c;>zRealm</span><span>'
</span><span style=color:#bf616a;>731:static</span><span> void NotAuthorized(const char *zRealm){
</span><span style=color:#bf616a;>740:    </span><span>"</span><span style=color:#a3be8c;>&LT/body>\n</span><span>", zRealm);
</span><span style=color:#bf616a;>910:</span><span>  char *zRealm = "</span><span style=color:#a3be8c;>unknown realm</span><span>";
</span><span style=color:#bf616a;>930:</span><span>      zRealm = StrDup(zVal);
</span><span style=color:#bf616a;>964:</span><span>  NotAuthorized(zRealm);
</span></code></pre><p>So I assume its just a way for the author to determine what kind of files were being requested.<p>According to the actual <a href=https://datatracker.ietf.org/doc/html/rfc1945#section-11>HTTP/1.0 specification for authentication</a>, we can see that realms are basically used to tell the requester that the same realm should require the same kind of authentication. Probably for caching purposes?<p>So it kinda makes sense that this value is not being used anywhere. It's more like a guideline, not a strict spec. It depends entirely if the resources are properly configured.<h3 id=references-15>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/printf.3.html>printf</a>.<li><a href=https://man7.org/linux/man-pages/man3/exit.3.html>exit</a>.<li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer>HTTP Header Referer</a>.<li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host>HTTP Header Host</a>.<li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent>HTTP Header User-Agent</a>.</ol><h1 id=cgierror>CgiError</h1><p>Another simple template to indicate CGI error.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Tell the client that there is an error in the script.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>CgiError</span><span>(</span><span style=color:#b48ead;>void</span><span>){
</span><span>  </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>500 Error</span><span>");
</span><span>  nOut += </span><span style=color:#96b5b4;>printf</span><span>(
</span><span>    "</span><span style=color:#a3be8c;>Content-type: text/html; charset=utf-8</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>&LThead>&LTtitle>CGI Program Error&LT/title>&LT/head></span><span style=color:#96b5b4;>\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>&LTbody>&LTh1>CGI Program Error&LT/h1></span><span style=color:#96b5b4;>\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>The CGI program </span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;> generated an error</span><span style=color:#96b5b4;>\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>&LT/body></span><span style=color:#96b5b4;>\n</span><span>", zScript);
</span><span>  </span><span style=color:#bf616a;>MakeLogEntry</span><span>(</span><span style=color:#d08770;>0</span><span>, </span><span style=color:#d08770;>120</span><span>);  </span><span style=color:#65737e;>/* LOG: CGI Error */
</span><span>  </span><span style=color:#96b5b4;>exit</span><span>(</span><span style=color:#d08770;>0</span><span>);
</span><span>}
</span></code></pre><p>Its only being used once,<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina.github.io</span><span> on  master </span><span style=color:#b48ead;>[</span><span>!?</span><span style=color:#b48ead;>]
</span><span style=color:#bf616a;></span><span> cat static/althttpd/althttpd.c | </span><span style=color:#bf616a;>rg --line-number </span><span>'</span><span style=color:#a3be8c;>CgiError</span><span>'
</span><span style=color:#bf616a;>747:static</span><span> void CgiError(void){
</span><span style=color:#bf616a;>2197:</span><span>      CgiError();
</span></code></pre><h1 id=timeout>Timeout</h1><p>A function that will be called to handle timeouts. AFAIK, the server is set up such that each request must be handled in a set amount of time. Beyond that, the server will just timeout.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** This is called if we timeout or catch some other kind of signal.
</span><span style=color:#65737e;>** Log an error code which is 900+iSig and then quit.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>Timeout</span><span>(</span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>iSig</span><span>){
</span><span>  </span><span style=color:#b48ead;>if</span><span>( !debugFlag ){
</span><span>    </span><span style=color:#b48ead;>if</span><span>( zScript && zScript[</span><span style=color:#d08770;>0</span><span>] ){
</span><span>      </span><span style=color:#b48ead;>char</span><span> zBuf[</span><span style=color:#d08770;>10</span><span>];
</span><span>      zBuf[</span><span style=color:#d08770;>0</span><span>] = '</span><span style=color:#a3be8c;>9</span><span>';
</span><span>      zBuf[</span><span style=color:#d08770;>1</span><span>] = '</span><span style=color:#a3be8c;>0</span><span>' + (iSig/</span><span style=color:#d08770;>10</span><span>)%</span><span style=color:#d08770;>10</span><span>;
</span><span>      zBuf[</span><span style=color:#d08770;>2</span><span>] = '</span><span style=color:#a3be8c;>0</span><span>' + iSig%</span><span style=color:#d08770;>10</span><span>;
</span><span>      zBuf[</span><span style=color:#d08770;>3</span><span>] = </span><span style=color:#d08770;>0</span><span>;
</span><span>      </span><span style=color:#96b5b4;>strcpy</span><span>(zReplyStatus, zBuf);
</span><span>      </span><span style=color:#bf616a;>MakeLogEntry</span><span>(</span><span style=color:#d08770;>0</span><span>, </span><span style=color:#d08770;>130</span><span>);  </span><span style=color:#65737e;>/* LOG: Timeout */
</span><span>    }
</span><span>    </span><span style=color:#96b5b4;>exit</span><span>(</span><span style=color:#d08770;>0</span><span>);
</span><span>  }
</span><span>}
</span></code></pre><p>There's 2 things that I am unsure here.<ol><li>Why do we need 10 bytes when we only use 4 of them?<li>Why is the the error code here <code>9XX</code> when there's already a HTTP request code for this. It appears to be for logging purposes only, which is weird because its only enabled when <code>debugFlag</code> is false.</ol><p>Let's see how it's bein used,<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina.github.io</span><span> on  master </span><span style=color:#b48ead;>[</span><span>!?</span><span style=color:#b48ead;>]
</span><span style=color:#bf616a;></span><span> cat static/althttpd/althttpd.c | </span><span style=color:#bf616a;>rg --line-number </span><span>'</span><span style=color:#a3be8c;>Timeout</span><span>'
</span><span style=color:#bf616a;>333:static</span><span> int useTimeout = 1;       </span><span style=color:#bf616a;>/*</span><span> True to use times */
</span><span style=color:#bf616a;>764:static</span><span> void Timeout(int iSig){
</span><span style=color:#bf616a;>773:</span><span>      MakeLogEntry(0, 130);  </span><span style=color:#bf616a;>/*</span><span> LOG: Timeout */
</span><span style=color:#bf616a;>1352:</span><span>  if( useTimeout ) </span><span style=color:#bf616a;>alarm</span><span>(30 + pStat->st_size/1000);
</span><span style=color:#bf616a;>1381:</span><span>  if( useTimeout ){
</span><span style=color:#bf616a;>1657:</span><span>  signal(SIGALRM, Timeout);
</span><span style=color:#bf616a;>1658:</span><span>  signal(SIGSEGV, Timeout);
</span><span style=color:#bf616a;>1659:</span><span>  signal(SIGPIPE, Timeout);
</span><span style=color:#bf616a;>1660:</span><span>  signal(SIGXCPU, Timeout);
</span><span style=color:#bf616a;>1661:</span><span>  if( useTimeout ) </span><span style=color:#bf616a;>alarm</span><span>(15);
</span><span style=color:#bf616a;>1930:</span><span>    if( useTimeout ) </span><span style=color:#bf616a;>alarm</span><span>(15 + len/2000);
</span><span style=color:#bf616a;>1939:</span><span>  if( useTimeout ) </span><span style=color:#bf616a;>alarm</span><span>(10);
</span><span style=color:#bf616a;>2224:</span><span>  if( useTimeout ) </span><span style=color:#bf616a;>alarm</span><span>(30);
</span><span style=color:#bf616a;>2417:</span><span>        useTimeout = 0;
</span><span style=color:#bf616a;>2540:INSERT</span><span> INTO xref VALUES(130,'</span><span style=color:#a3be8c;>Timeout</span><span>');
</span></code></pre><p>So it seems to register itself to a bunch of signals and that's pretty much it.<h3 id=references-16>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/signal.3p.html>signal</a>.<li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/408>HTTP Status Request Timeout</a>.</ol><h1 id=cgiscriptwritable>CgiScriptWritable</h1><p>Just another HTTP response template for CGI errors.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Tell the client that there is an error in the script.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>CgiScriptWritable</span><span>(</span><span style=color:#b48ead;>void</span><span>){
</span><span>  </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>500 CGI Configuration Error</span><span>");
</span><span>  nOut += </span><span style=color:#96b5b4;>printf</span><span>(
</span><span>    "</span><span style=color:#a3be8c;>Content-type: text/plain; charset=utf-8</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>The CGI program </span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;> is writable by users other than its owner.</span><span style=color:#96b5b4;>\n</span><span>",
</span><span>    zRealScript);
</span><span>  </span><span style=color:#bf616a;>MakeLogEntry</span><span>(</span><span style=color:#d08770;>0</span><span>, </span><span style=color:#d08770;>140</span><span>);  </span><span style=color:#65737e;>/* LOG: CGI script is writable */
</span><span>  </span><span style=color:#96b5b4;>exit</span><span>(</span><span style=color:#d08770;>0</span><span>);
</span><span>}
</span></code></pre><p>As the function name implies, it's being used whenever a script is writable by group and other have write permission to the file. See "The file type and mode" section in the inode manual below.<h3 id=references-17>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man7/inode.7.html>inode</a>.</ol><h1 id=malfunction>Malfunction</h1><p>This is a template for a generic error in the server.<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Tell the client that the server malfunctioned.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>Malfunction</span><span>(</span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>linenum</span><span>, </span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zFormat</span><span>, ...){
</span><span>  va_list ap;
</span><span>  </span><span style=color:#96b5b4;>va_start</span><span>(ap, zFormat);
</span><span>  </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>500 Server Malfunction</span><span>");
</span><span>  nOut += </span><span style=color:#96b5b4;>printf</span><span>(
</span><span>    "</span><span style=color:#a3be8c;>Content-type: text/plain; charset=utf-8</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#96b5b4;>\r\n</span><span>"
</span><span>    "</span><span style=color:#a3be8c;>Web server malfunctioned; error number </span><span style=color:#d08770;>%d</span><span style=color:#96b5b4;>\n\n</span><span>", linenum);
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zFormat ){
</span><span>    nOut += </span><span style=color:#96b5b4;>vprintf</span><span>(zFormat, ap);
</span><span>    </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#96b5b4;>\n</span><span>");
</span><span>    nOut++;
</span><span>  }
</span><span>  </span><span style=color:#bf616a;>MakeLogEntry</span><span>(</span><span style=color:#d08770;>0</span><span>, linenum);
</span><span>  </span><span style=color:#96b5b4;>exit</span><span>(</span><span style=color:#d08770;>0</span><span>);
</span><span>}
</span></code></pre><p>The strange part about this is that it exit the process with 0. If its malfunctioning, I assume it's supposed to return a negative value. It's being used in a variety of places, covering various kinds of errors.<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina.github.io</span><span> on  master </span><span style=color:#b48ead;>[</span><span>!?</span><span style=color:#b48ead;>]
</span><span style=color:#bf616a;></span><span> cat static/althttpd/althttpd.c | </span><span style=color:#bf616a;>rg --line-number --fixed-strings </span><span>"</span><span style=color:#a3be8c;>Malfunction</span><span>"796:static void Malfunction(int linenum, const char *zFormat, ...){
</span><span style=color:#bf616a;>799:</span><span>  StartResponse("</span><span style=color:#a3be8c;>500 Server Malfunction</span><span>");
</span><span style=color:#bf616a;>1413:</span><span>          Malfunction(600, "</span><span style=color:#a3be8c;>Out of memory: %d bytes</span><span>", nMalloc);
</span><span style=color:#bf616a;>1451:</span><span>           Malfunction(610, "</span><span style=color:#a3be8c;>Out of memory: %d bytes</span><span>", nMalloc);
</span><span style=color:#bf616a;>1492:</span><span>    Malfunction(700, "</span><span style=color:#a3be8c;>cannot open </span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>\n</span><span>", zFile);
</span><span style=color:#bf616a;>1495:</span><span>    Malfunction(701, "</span><span style=color:#a3be8c;>cannot read </span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>\n</span><span>", zFile);
</span><span style=color:#bf616a;>1498:</span><span>    Malfunction(702, "</span><span style=color:#a3be8c;>misformatted SCGI spec </span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>\n</span><span>", zFile);
</span><span style=color:#bf616a;>1504:</span><span>    Malfunction(703, "</span><span style=color:#a3be8c;>misformatted SCGI spec </span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>\n</span><span>", zFile);
</span><span style=color:#bf616a;>1521:</span><span>    Malfunction(704, "</span><span style=color:#a3be8c;>unrecognized line in SCGI spec: </span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>%s %s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>\n</span><span>",
</span><span style=color:#bf616a;>1531:</span><span>    Malfunction(704, "</span><span style=color:#a3be8c;>cannot resolve SCGI server name %s:%s\n%s\n</span><span>",
</span><span style=color:#bf616a;>1546:</span><span>          Malfunction(721,"</span><span style=color:#a3be8c;>Relight failed with %d: </span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>\n</span><span>",
</span><span style=color:#bf616a;>1560:</span><span>          Malfunction(720, /* LOG: chdir() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>1571:</span><span>          Malfunction(706, "</span><span style=color:#a3be8c;>bad fallback file: </span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>%s</span><span style=color:#96b5b4;>\"</span><span style=color:#a3be8c;>\n</span><span>", zFallback);
</span><span style=color:#bf616a;>1574:</span><span>      Malfunction(707, "</span><span style=color:#a3be8c;>cannot open socket to SCGI server %s\n</span><span>",
</span><span style=color:#bf616a;>1593:</span><span>        Malfunction(706, "</span><span style=color:#a3be8c;>out of memory</span><span>");
</span><span style=color:#bf616a;>1648:</span><span>    Malfunction(190,   /* LOG: chdir() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>1915:</span><span>      Malfunction(280,  /* LOG: mkstemp() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2017:</span><span>    Malfunction(360,  /* LOG: chdir() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2122:</span><span>      Malfunction(420, /* LOG: chdir() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2151:</span><span>        Malfunction(430,  /* LOG: dup(0) </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2177:</span><span>        Malfunction(440, /* LOG: pipe() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2184:</span><span>          Malfunction(450, /* LOG: dup(1) </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2408:</span><span>        Malfunction(500,  /* LOG: unknown IP protocol */
</span><span style=color:#bf616a;>2421:</span><span>        Malfunction(501, /* LOG: cannot open</span><span style=color:#bf616a;> --input</span><span> file */
</span><span style=color:#bf616a;>2429:</span><span>      Malfunction(510, /* LOG: unknown command-line argument on launch */
</span><span style=color:#bf616a;>2439:</span><span>      Malfunction(520, /* LOG:</span><span style=color:#bf616a;> --root</span><span> argument missing */
</span><span style=color:#bf616a;>2448:</span><span>    Malfunction(530, /* LOG: chdir() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2458:</span><span>      Malfunction(540, /* LOG: chroot() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2467:</span><span>    Malfunction(550, /* LOG: server startup failed */
</span><span style=color:#bf616a;>2485:</span><span>        Malfunction(560, /* LOG: setgid() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2489:</span><span>        Malfunction(570, /* LOG: setuid() </span><span style=color:#bf616a;>failed </span><span>*/
</span><span style=color:#bf616a;>2493:</span><span>      Malfunction(580, /* LOG: unknown user */
</span><span style=color:#bf616a;>2498:</span><span>    Malfunction(590, /* LOG: cannot run as root */
</span></code></pre><h3 id=references-18>References</h3><ol><li><a href=https://man7.org/linux/man-pages/man3/exit.3.html>exit</a></ol><h1 id=redirect>Redirect</h1><pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** Do a server redirect to the document specified.  The document
</span><span style=color:#65737e;>** name not contain scheme or network location or the query string.
</span><span style=color:#65737e;>** It will be just the path.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>static void </span><span style=color:#8fa1b3;>Redirect</span><span>(</span><span style=color:#b48ead;>const char </span><span>*</span><span style=color:#bf616a;>zPath</span><span>, </span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>iStatus</span><span>, </span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>finish</span><span>, </span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>lineno</span><span>){
</span><span>  </span><span style=color:#b48ead;>switch</span><span>( iStatus ){
</span><span>    </span><span style=color:#b48ead;>case </span><span style=color:#d08770;>301</span><span>:
</span><span>      </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>301 Permanent Redirect</span><span>");
</span><span>      </span><span style=color:#b48ead;>break</span><span>;
</span><span>    </span><span style=color:#b48ead;>case </span><span style=color:#d08770;>308</span><span>:
</span><span>      </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>308 Permanent Redirect</span><span>");
</span><span>      </span><span style=color:#b48ead;>break</span><span>;
</span><span>    </span><span style=color:#b48ead;>default</span><span>:
</span><span>      </span><span style=color:#bf616a;>StartResponse</span><span>("</span><span style=color:#a3be8c;>302 Temporary Redirect</span><span>");
</span><span>      </span><span style=color:#b48ead;>break</span><span>;
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>if</span><span>( zServerPort==</span><span style=color:#d08770;>0 </span><span>|| zServerPort[</span><span style=color:#d08770;>0</span><span>]==</span><span style=color:#d08770;>0 </span><span>|| </span><span style=color:#96b5b4;>strcmp</span><span>(zServerPort,"</span><span style=color:#a3be8c;>80</span><span>")==</span><span style=color:#d08770;>0 </span><span>){
</span><span>    nOut += </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#a3be8c;>Location: </span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>://</span><span style=color:#d08770;>%s%s%s</span><span style=color:#96b5b4;>\r\n</span><span>",
</span><span>                   zHttp, zServerName, zPath, zQuerySuffix);
</span><span>  }</span><span style=color:#b48ead;>else</span><span>{
</span><span>    nOut += </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#a3be8c;>Location: </span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>://</span><span style=color:#d08770;>%s</span><span style=color:#a3be8c;>:</span><span style=color:#d08770;>%s%s%s</span><span style=color:#96b5b4;>\r\n</span><span>",
</span><span>                   zHttp, zServerName, zServerPort, zPath, zQuerySuffix);
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>if</span><span>( finish ){
</span><span>    nOut += </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#a3be8c;>Content-length: 0</span><span style=color:#96b5b4;>\r\n</span><span>");
</span><span>    nOut += </span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#96b5b4;>\r\n</span><span>");
</span><span>    </span><span style=color:#bf616a;>MakeLogEntry</span><span>(</span><span style=color:#d08770;>0</span><span>, lineno);
</span><span>  }
</span><span>  </span><span style=color:#96b5b4;>fflush</span><span>(stdout);
</span><span>}
</span></code></pre><p>This function simply redirects using the <a href=https://hbina.github.io/althttp-from-top-to-bottom/#startresponse>StartResponse</a> that we have previously seen.<h3 id=the-different-kinds-of-http-status-code-for-redirection>The Different Kinds of HTTP Status Code for Redirection</h3><p>The first it does is to map the integer given in <code>iStatus</code> to their complete HTTP status code. I would like to not however that the first and the last statuses in use here are incorrect.<p>Using <a href=https://www.iana.org/assignments/http-status-codes/http-status-codes.xhtml>IANA</a> itself as reference, we can see that we should change:<ol><li><p>"301 Permanent Redirect" => "301 Moved Permanently"</p><li><p>"302 Temporary Redirect" => "302 Found"</p></ol><p>If the intention is to used indicate "temporary redirect", then the correct status code for that is "307 Temporary Indirect". As far as I know, the standard says that only the first 3 letters (the numeric part of the status code) actually matters. I have already raised a ticket for this <a href="https://sqlite.org/althttpd/tktview?name=2ac5f38c13">here</a>.<h3 id=where-to-redirect>Where to Redirect</h3><p>The way a client determine where it should retry is provided in the <code>Location</code> header. This is what the second part of this function is doing.<p>If a port is provided (and it is not port 80 which is already used by the HTTP server), then it will append the port to the domain.<p>If there are no additional data to be included into this response, then it will add the header "Content-Length" with the value 0 to indicate an empty body. However, if we grep for the usage of this function, we can see that we will <em>always</em> finish here.<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina@akarin:~/git/hbina.github.io$</span><span> rg '</span><span style=color:#a3be8c;>Redirect\(</span><span>' ./static/althttpd/althttpd.c
</span><span style=color:#bf616a;>819:static</span><span> void Redirect(const char *zPath, int iStatus, int finish, int lineno){
</span><span style=color:#bf616a;>951:</span><span>        Redirect(zScript, 301, 1, 170); </span><span style=color:#bf616a;>/*</span><span> LOG:</span><span style=color:#bf616a;> -auth</span><span> redirect */
</span><span style=color:#bf616a;>2044:</span><span>          Redirect(zRealScript, 302, 1, 370); </span><span style=color:#bf616a;>/*</span><span> LOG: redirect to not-found */
</span><span style=color:#bf616a;>2080:</span><span>        Redirect(zRealScript,301,1,410); </span><span style=color:#bf616a;>/*</span><span> LOG: redirect to add trailing / */
</span></code></pre><p>Finally, we will flush the buffer to stdout. However, I am not particularly sure why we explicitly do it here and not before we finally want to exit from this fork.<h1 id=decode64>Decode64</h1><pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#65737e;>/*
</span><span style=color:#65737e;>** This function treats its input as a base-64 string and returns the
</span><span style=color:#65737e;>** decoded value of that string.  Characters of input that are not
</span><span style=color:#65737e;>** valid base-64 characters (such as spaces and newlines) are ignored.
</span><span style=color:#65737e;>*/
</span><span style=color:#b48ead;>void </span><span style=color:#8fa1b3;>Decode64</span><span>(</span><span style=color:#b48ead;>char </span><span>*</span><span style=color:#bf616a;>z64</span><span>){
</span><span>  </span><span style=color:#b48ead;>char </span><span>*zData;
</span><span>  </span><span style=color:#b48ead;>int</span><span> n64;
</span><span>  </span><span style=color:#b48ead;>int</span><span> i, j;
</span><span>  </span><span style=color:#b48ead;>int</span><span> a, b, c, d;
</span><span>  </span><span style=color:#b48ead;>static int</span><span> isInit = </span><span style=color:#d08770;>0</span><span>;
</span><span>  </span><span style=color:#b48ead;>static int</span><span> trans[</span><span style=color:#d08770;>128</span><span>];
</span><span>  </span><span style=color:#b48ead;>static unsigned char</span><span> zBase[] =
</span><span>    "</span><span style=color:#a3be8c;>ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/</span><span>";
</span><span>
</span><span>  </span><span style=color:#b48ead;>if</span><span>( !isInit ){
</span><span>    </span><span style=color:#b48ead;>for</span><span>(i=</span><span style=color:#d08770;>0</span><span>; i<</span><span style=color:#d08770;>128</span><span>; i++){ trans[i] = </span><span style=color:#d08770;>0</span><span>; }
</span><span>    </span><span style=color:#b48ead;>for</span><span>(i=</span><span style=color:#d08770;>0</span><span>; zBase[i]; i++){ trans[zBase[i] & </span><span style=color:#d08770;>0x7f</span><span>] = i; }
</span><span>    isInit = </span><span style=color:#d08770;>1</span><span>;
</span><span>  }
</span><span>  n64 = </span><span style=color:#96b5b4;>strlen</span><span>(z64);
</span><span>  </span><span style=color:#b48ead;>while</span><span>( n64></span><span style=color:#d08770;>0 </span><span>&& z64[n64-</span><span style=color:#d08770;>1</span><span>]=='</span><span style=color:#a3be8c;>=</span><span>' ) n64--;
</span><span>  zData = z64;
</span><span>  </span><span style=color:#b48ead;>for</span><span>(i=j=</span><span style=color:#d08770;>0</span><span>; i+</span><span style=color:#d08770;>3</span><span>&LTn64; i+=</span><span style=color:#d08770;>4</span><span>){
</span><span>    a = trans[z64[i] & </span><span style=color:#d08770;>0x7f</span><span>];
</span><span>    b = trans[z64[i+</span><span style=color:#d08770;>1</span><span>] & </span><span style=color:#d08770;>0x7f</span><span>];
</span><span>    c = trans[z64[i+</span><span style=color:#d08770;>2</span><span>] & </span><span style=color:#d08770;>0x7f</span><span>];
</span><span>    d = trans[z64[i+</span><span style=color:#d08770;>3</span><span>] & </span><span style=color:#d08770;>0x7f</span><span>];
</span><span>    zData[j++] = ((a<<</span><span style=color:#d08770;>2</span><span>) & </span><span style=color:#d08770;>0xfc</span><span>) | ((b>></span><span style=color:#d08770;>4</span><span>) & </span><span style=color:#d08770;>0x03</span><span>);
</span><span>    zData[j++] = ((b<<</span><span style=color:#d08770;>4</span><span>) & </span><span style=color:#d08770;>0xf0</span><span>) | ((c>></span><span style=color:#d08770;>2</span><span>) & </span><span style=color:#d08770;>0x0f</span><span>);
</span><span>    zData[j++] = ((c<<</span><span style=color:#d08770;>6</span><span>) & </span><span style=color:#d08770;>0xc0</span><span>) | (d & </span><span style=color:#d08770;>0x3f</span><span>);
</span><span>  }
</span><span>  </span><span style=color:#b48ead;>if</span><span>( i+</span><span style=color:#d08770;>2</span><span>&LTn64 ){
</span><span>    a = trans[z64[i] & </span><span style=color:#d08770;>0x7f</span><span>];
</span><span>    b = trans[z64[i+</span><span style=color:#d08770;>1</span><span>] & </span><span style=color:#d08770;>0x7f</span><span>];
</span><span>    c = trans[z64[i+</span><span style=color:#d08770;>2</span><span>] & </span><span style=color:#d08770;>0x7f</span><span>];
</span><span>    zData[j++] = ((a<<</span><span style=color:#d08770;>2</span><span>) & </span><span style=color:#d08770;>0xfc</span><span>) | ((b>></span><span style=color:#d08770;>4</span><span>) & </span><span style=color:#d08770;>0x03</span><span>);
</span><span>    zData[j++] = ((b<<</span><span style=color:#d08770;>4</span><span>) & </span><span style=color:#d08770;>0xf0</span><span>) | ((c>></span><span style=color:#d08770;>2</span><span>) & </span><span style=color:#d08770;>0x0f</span><span>);
</span><span>  }</span><span style=color:#b48ead;>else if</span><span>( i+</span><span style=color:#d08770;>1</span><span>&LTn64 ){
</span><span>    a = trans[z64[i] & </span><span style=color:#d08770;>0x7f</span><span>];
</span><span>    b = trans[z64[i+</span><span style=color:#d08770;>1</span><span>] & </span><span style=color:#d08770;>0x7f</span><span>];
</span><span>    zData[j++] = ((a<<</span><span style=color:#d08770;>2</span><span>) & </span><span style=color:#d08770;>0xfc</span><span>) | ((b>></span><span style=color:#d08770;>4</span><span>) & </span><span style=color:#d08770;>0x03</span><span>);
</span><span>  }
</span><span>  zData[j] = </span><span style=color:#d08770;>0</span><span>;
</span><span>}
</span></code></pre><p>This function decodes <a href=https://en.wikipedia.org/wiki/Base64>base64</a> C-string input into its binary data. Interestingly, this function does not perform any allocation. The decoding is done in-place in the original buffer.<p>Here's a <a href=../althttpd/decode_base64_test.c>test program</a> to see the result of decoding some data.<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>hbina@akarin:~/git/hbina.github.io$</span><span> clang ./static/althttpd/decode_base64_test.c  && </span><span style=color:#bf616a;>./a.out
</span><span style=color:#bf616a;>Encoded:</span><span>'</span><span style=color:#a3be8c;>TWFueSBoYW5kcyBtYWtlIGxpZ2h0IHdvcmsu===============</span><span>'
</span><span style=color:#bf616a;>Decoded:</span><span>'</span><span style=color:#a3be8c;>Many hands make light work.</span><span>'
</span></code></pre><p>Note that this is for illustrative purpose only. The <code>base64</code> encoding is used to encode binary data which may contain a bunch of <code>O</code>s and/or non-printable characters. Thefore, the result of decoded data cannot be trivially printed.</div><section><hr><p>[<a href=/>Home</a>]<p>My resume <a href=/resume.html>here</a>.<p>Source code available <a href=https://github.com/hbina/hbina.github.io>here</a>. You can raise an issue if ... you have an issue with it.